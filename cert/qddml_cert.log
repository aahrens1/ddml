--------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\LocalStore\ecomes\Documents\GitHub\ddml\cert\qddml_cert.log
  log type:  text
 opened on:   8 Jul 2023, 23:00:23

. 
. global tol = 0.0001

. which ddml
C:\LocalStore\ecomes\Documents\GitHub\ddml\ddml.ado
*! ddml v1.2
*! last edited: 8 july 2023
*! authors: aa/ms

. which pystacked
C:\LocalStore\ecomes\Documents\GitHub\pystacked\pystacked.ado
*! pystacked v0.7.1
*! last edited: 1april2023
*! authors: aa/ms

.         
. **** Partially linear model.
. 
. use https://github.com/aahrens1/ddml/raw/master/data/sipp1991.dta, clear

. global Y net_tfa

. global D e401

. global X tw age inc fsize educ db marr twoearn pira hown

. 
. set seed 42

. ddml init partial, kfolds(2)

. ddml E[Y|X]: pystacked $Y $X, type(reg) method(rf)
Learner Y1_pystacked added successfully.

. ddml E[D|X]: pystacked $D $X, type(reg) method(rf)
Learner D1_pystacked added successfully.

. ddml crossfit
Cross-fitting E[y|X] equation: net_tfa
Cross-fitting fold 1 2 ...completed cross-fitting
Cross-fitting E[D|X] equation: e401
Cross-fitting fold 1 2 ...completed cross-fitting

. ddml estimate  


Model:                  partial, crossfit folds k=2, resamples r=1
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_pystacked
D equations (1):        e401
 e401 learners:         D1_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE 
   1  1  Y1_pystacked  D1_pystacked  6979.699  (767.306)

DDML model
y-E[y|X]  = y-Y1_pystacked_1                       Number of obs   =      9915
D-E[D|X]  = D-D1_pystacked_1 
------------------------------------------------------------------------------
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   6979.699   767.3058     9.10   0.000     5475.807     8483.59
       _cons |  -246.4576   352.9981    -0.70   0.485    -938.3211    445.4059
------------------------------------------------------------------------------


. local b1 = _b[$D]

. 
. set seed 42

. qddml $Y $D ($X), kfolds(2) model(partial) cmd(pystacked) cmdopt(type(reg) method(rf))
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized
Learner Y1_pystacked added successfully.
Learner D1_pystacked added successfully.
shortstack  requested but must have multiple learners in all equations; option ignored
Cross-fitting E[y|X] equation: net_tfa
Cross-fitting fold 1 2 ...completed cross-fitting
Cross-fitting E[D|X] equation: e401
Cross-fitting fold 1 2 ...completed cross-fitting


Model:                  partial, crossfit folds k=2, resamples r=1
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_pystacked
D equations (1):        e401
 e401 learners:         D1_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE 
   1  1  Y1_pystacked  D1_pystacked  6979.699  (767.306)

DDML model
y-E[y|X]  = y-Y1_pystacked_1                       Number of obs   =      9915
D-E[D|X]  = D-D1_pystacked_1 
------------------------------------------------------------------------------
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   6979.699   767.3058     9.10   0.000     5475.807     8483.59
       _cons |  -246.4576   352.9981    -0.70   0.485    -938.3211    445.4059
------------------------------------------------------------------------------


. local b2 = _b[$D]

. ddml estimate 


Model:                  partial, crossfit folds k=2, resamples r=1
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_pystacked
D equations (1):        e401
 e401 learners:         D1_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE 
   1  1  Y1_pystacked  D1_pystacked  6979.699  (767.306)

DDML model
y-E[y|X]  = y-Y1_pystacked_1                       Number of obs   =      9915
D-E[D|X]  = D-D1_pystacked_1 
------------------------------------------------------------------------------
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   6979.699   767.3058     9.10   0.000     5475.807     8483.59
       _cons |  -246.4576   352.9981    -0.70   0.485    -938.3211    445.4059
------------------------------------------------------------------------------


. 
. assert reldif(`b1',`b2')<$tol

. 
. **** Partially linear IV model.
. 
. use https://statalasso.github.io/dta/AJR.dta, clear

. global Y logpgp95

. global D avexpr

. global Z logem4

. global X lat_abst edes1975 avelf temp* humid* steplow-oilres

. 
. set seed 42

. ddml init iv, kfolds(30)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. ddml E[Y|X], vtype(none): rforest $Y $X, type(reg)
Learner Y1_rforest added successfully.

. ddml E[D|X], vtype(none): rforest $D $X, type(reg)
Learner D1_rforest added successfully.

. ddml E[Z|X], vtype(none): rforest $Z $X, type(reg)
Learner Z1_rforest added successfully.

. ddml crossfit
Cross-fitting E[y|X] equation: logpgp95
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting
Cross-fitting E[D|X] equation: avexpr
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting
Cross-fitting E[Z|X]: logem4
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting

. ddml estimate, robust


Model:                  iv, crossfit folds k=30, resamples r=1
Dependent variable (Y): logpgp95
 logpgp95 learners:     Y1_rforest
D equations (1):        avexpr
 avexpr learners:       D1_rforest
Z equations (1):        logem4
 logem4 learners:       Z1_rforest

DDML estimation results:
spec  r     Y learner     D learner         b        SE      Z learner
   1  1    Y1_rforest    D1_rforest     0.772    (0.207)    Z1_rforest

DDML model
y-E[y|X]  = y-Y1_rforest_1                         Number of obs   =        64
D-E[D|X]  = D-D1_rforest_1 
Z-E[Z|X]  = Z-Z1_rforest_1 
------------------------------------------------------------------------------
             |               Robust
    logpgp95 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      avexpr |   .7723141   .2068282     3.73   0.000     .3669382     1.17769
       _cons |  -.0119092    .100929    -0.12   0.906    -.2097263    .1859079
------------------------------------------------------------------------------


. local b1 = _b[$D]

. 
. set seed 42

. qddml $Y ($X) ($D=$Z), kfolds(30) model(iv) cmd(rforest) cmdopt(type(reg)) vtype(none) robust
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized
Learner Y1_rforest added successfully.
Learner D1_rforest added successfully.
Learner Z1_rforest added successfully.
shortstack  requested but must have multiple learners in all equations; option ignored
Cross-fitting E[y|X] equation: logpgp95
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting
Cross-fitting E[D|X] equation: avexpr
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting
Cross-fitting E[Z|X]: logem4
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting


Model:                  iv, crossfit folds k=30, resamples r=1
Dependent variable (Y): logpgp95
 logpgp95 learners:     Y1_rforest
D equations (1):        avexpr
 avexpr learners:       D1_rforest
Z equations (1):        logem4
 logem4 learners:       Z1_rforest

DDML estimation results:
spec  r     Y learner     D learner         b        SE      Z learner
   1  1    Y1_rforest    D1_rforest     0.772    (0.207)    Z1_rforest

DDML model
y-E[y|X]  = y-Y1_rforest_1                         Number of obs   =        64
D-E[D|X]  = D-D1_rforest_1 
Z-E[Z|X]  = Z-Z1_rforest_1 
------------------------------------------------------------------------------
             |               Robust
    logpgp95 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      avexpr |   .7723141   .2068282     3.73   0.000     .3669382     1.17769
       _cons |  -.0119092    .100929    -0.12   0.906    -.2097263    .1859079
------------------------------------------------------------------------------


. local b2 = _b[$D]

. 
. assert reldif(`b1',`b2')<$tol

. 
. **** Interactive model--ATE and ATET estimation.
. 
. webuse cattaneo2, clear
(Excerpt from Cattaneo (2010) Journal of Econometrics 155: 138-154)

. global Y bweight

. global D mbsmoke

. global X mage prenatal1 mmarried fbaby mage medu

. set seed 42

. 
. ddml init interactive, kfolds(5) reps(5)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. ddml E[Y|X,D]: pystacked $Y $X, type(reg) method(gradboost)
Learner Y1_pystacked added successfully.

. ddml E[D|X]: pystacked $D $X, type(class) method(gradboost)
Learner D1_pystacked added successfully.

. ddml crossfit
Cross-fitting E[y|X,D] equation: bweight
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[D|X] equation: mbsmoke
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting

. ddml estimate


Model:                  interactive, crossfit folds k=5, resamples r=5
Dependent variable (Y): bweight
 bweight learners:      Y1_pystacked
D equations (1):        mbsmoke
 mbsmoke learners:      D1_pystacked

DDML estimation results (ATE):
spec  r  Y(0) learner  Y(1) learner     D learner         b        SE 
   1  1  Y1_pystacked  Y1_pystacked  D1_pystacked  -195.812   (30.885)
   1  2  Y1_pystacked  Y1_pystacked  D1_pystacked  -199.401   (32.442)
   1  3  Y1_pystacked  Y1_pystacked  D1_pystacked  -227.291   (32.605)
   1  4  Y1_pystacked  Y1_pystacked  D1_pystacked  -234.604   (33.826)
   1  5  Y1_pystacked  Y1_pystacked  D1_pystacked  -215.839   (31.833)

Mean/med Y(0) learner  Y(1) learner     D learner         b        SE 
 mse mn     [min-mse]         [mse]         [mse]  -214.589   (35.381)
 mse md     [min-mse]         [mse]         [mse]  -215.839   (36.369)

Median over 5 resamples (ATE)
E[y|X,D=0]   = Y1_pystacked0                       Number of obs   =      4642
E[y|X,D=1]   = Y1_pystacked1
E[D|X]       = D1_pystacked
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |  -215.8387   36.36916    -5.93   0.000    -287.1209   -144.5565
------------------------------------------------------------------------------
Warning: 5 resamples had propensity scores trimmed to lower limit .01.

Summary over 5 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -214.5893 -234.6039 -227.2912 -215.8387 -199.4008 -195.8117

. local b1 = _b[$D]

. 
. ddml estimate, atet


Model:                  interactive, crossfit folds k=5, resamples r=5
Dependent variable (Y): bweight
 bweight learners:      Y1_pystacked
D equations (1):        mbsmoke
 mbsmoke learners:      D1_pystacked

DDML estimation results (ATET):
spec  r  Y(0) learner  Y(1) learner     D learner         b        SE 
   1  1  Y1_pystacked  Y1_pystacked  D1_pystacked  -228.707   (25.699)
   1  2  Y1_pystacked  Y1_pystacked  D1_pystacked  -229.323   (25.031)
   1  3  Y1_pystacked  Y1_pystacked  D1_pystacked  -231.423   (27.400)
   1  4  Y1_pystacked  Y1_pystacked  D1_pystacked  -243.639   (24.590)
   1  5  Y1_pystacked  Y1_pystacked  D1_pystacked  -237.354   (24.847)

Mean/med Y(0) learner  Y(1) learner     D learner         b        SE 
 mse mn     [min-mse]         [mse]         [mse]  -234.089   (26.101)
 mse md     [min-mse]         [mse]         [mse]  -231.423   (25.842)

Median over 5 resamples (ATET)
E[y|X,D=0]   = Y1_pystacked0                       Number of obs   =      4642
E[y|X,D=1]   = Y1_pystacked1
E[D|X]       = D1_pystacked
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |  -231.4228   25.84174    -8.96   0.000    -282.0716   -180.7739
------------------------------------------------------------------------------
Warning: 5 resamples had propensity scores trimmed to lower limit .01.

Summary over 5 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -234.0891 -243.6388 -237.3540 -231.4228 -229.3230 -228.7068

. local b1_atet=_b[$D]

. 
. set seed 42

. qddml $Y $D ($X), kfolds(5) reps(5) model(interactive) cmd(pystacked) ycmdopt(type(reg) method(gradboost)) dcmdopt(type(
> class) method(gradboost))
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized
Learner Y1_pystacked added successfully.
Learner D1_pystacked added successfully.
shortstack  requested but must have multiple learners in all equations; option ignored
Cross-fitting E[y|X,D] equation: bweight
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[D|X] equation: mbsmoke
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting


Model:                  interactive, crossfit folds k=5, resamples r=5
Dependent variable (Y): bweight
 bweight learners:      Y1_pystacked
D equations (1):        mbsmoke
 mbsmoke learners:      D1_pystacked

DDML estimation results (ATE):
spec  r  Y(0) learner  Y(1) learner     D learner         b        SE 
   1  1  Y1_pystacked  Y1_pystacked  D1_pystacked  -195.812   (30.885)
   1  2  Y1_pystacked  Y1_pystacked  D1_pystacked  -199.401   (32.442)
   1  3  Y1_pystacked  Y1_pystacked  D1_pystacked  -227.291   (32.605)
   1  4  Y1_pystacked  Y1_pystacked  D1_pystacked  -234.604   (33.826)
   1  5  Y1_pystacked  Y1_pystacked  D1_pystacked  -215.839   (31.833)

Mean/med Y(0) learner  Y(1) learner     D learner         b        SE 
 mse mn     [min-mse]         [mse]         [mse]  -214.589   (35.381)
 mse md     [min-mse]         [mse]         [mse]  -215.839   (36.369)

Median over 5 resamples (ATE)
E[y|X,D=0]   = Y1_pystacked0                       Number of obs   =      4642
E[y|X,D=1]   = Y1_pystacked1
E[D|X]       = D1_pystacked
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |  -215.8387   36.36916    -5.93   0.000    -287.1209   -144.5565
------------------------------------------------------------------------------
Warning: 5 resamples had propensity scores trimmed to lower limit .01.

Summary over 5 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -214.5893 -234.6039 -227.2912 -215.8387 -199.4008 -195.8117

. local b2 = _b[$D]

. 
. ddml estimate, atet


Model:                  interactive, crossfit folds k=5, resamples r=5
Dependent variable (Y): bweight
 bweight learners:      Y1_pystacked
D equations (1):        mbsmoke
 mbsmoke learners:      D1_pystacked

DDML estimation results (ATET):
spec  r  Y(0) learner  Y(1) learner     D learner         b        SE 
   1  1  Y1_pystacked  Y1_pystacked  D1_pystacked  -228.707   (25.699)
   1  2  Y1_pystacked  Y1_pystacked  D1_pystacked  -229.323   (25.031)
   1  3  Y1_pystacked  Y1_pystacked  D1_pystacked  -231.423   (27.400)
   1  4  Y1_pystacked  Y1_pystacked  D1_pystacked  -243.639   (24.590)
   1  5  Y1_pystacked  Y1_pystacked  D1_pystacked  -237.354   (24.847)

Mean/med Y(0) learner  Y(1) learner     D learner         b        SE 
 mse mn     [min-mse]         [mse]         [mse]  -234.089   (26.101)
 mse md     [min-mse]         [mse]         [mse]  -231.423   (25.842)

Median over 5 resamples (ATET)
E[y|X,D=0]   = Y1_pystacked0                       Number of obs   =      4642
E[y|X,D=1]   = Y1_pystacked1
E[D|X]       = D1_pystacked
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |  -231.4228   25.84174    -8.96   0.000    -282.0716   -180.7739
------------------------------------------------------------------------------
Warning: 5 resamples had propensity scores trimmed to lower limit .01.

Summary over 5 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -234.0891 -243.6388 -237.3540 -231.4228 -229.3230 -228.7068

. local b2_atet=_b[$D]

. 
. assert reldif(`b1',`b2')<$tol

. assert reldif(`b1_atet',`b2_atet')<$tol

. 
. 
. **** Interactive IV model--LATE estimation.
. 
. use http://fmwww.bc.edu/repec/bocode/j/jtpa.dta,clear

. global Y earnings

. global D training

. global Z assignmt

. global X sex age married black hispanic

. set seed 42

. 
. ddml init interactiveiv, kfolds(5)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. ddml E[Y|X,Z]: pystacked $Y c.($X)# #c($X), type(reg) m(lassocv)
Learner Y1_pystacked added successfully.

. ddml E[D|X,Z]: pystacked $D c.($X)# #c($X), type(class) m(lassocv)
Learner D1_pystacked added successfully.

. ddml E[Z|X]: pystacked $Z c.($X)# #c($X), type(class) m(lassocv)
Learner Z1_pystacked added successfully.

. ddml crossfit
Cross-fitting E[y|X,Z] equation: earnings
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[D|X,Z] equation: training
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[Z|X]: assignmt
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting

. ddml estimate


Model:                  late, crossfit folds k=5, resamples r=1
Dependent variable (Y): earnings
 earnings learners:     Y1_pystacked
D equations (1):        training
 training learners:     D1_pystacked
Z equations (1):        assignmt
 assignmt learners:     Z1_pystacked

DDML estimation results (LATE):
spec  r  Y(0) learner  Y(1) learner  D(0) learner  D(1) learner         b        SE      Z learner
   1  1  Y1_pystacked  Y1_pystacked  D1_pystacked  D1_pystacked  1824.216  (514.244)  Z1_pystacked

DDML model (LATE)
E[y|X,D=0]   = Y1_pystacked0_1                     Number of obs   =     11204
E[y|X,D=1]   = Y1_pystacked1_1
E[D|X,Z=0]   = D1_pystacked0_1
E[D|X,Z=1]   = D1_pystacked1_1
E[Z|X]       = Z1_pystacked_1
------------------------------------------------------------------------------
             |               Robust
    earnings |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    training |   1824.216   514.2438     3.55   0.000     816.3162    2832.115
------------------------------------------------------------------------------


. local b1 = _b[$D]

. 
. set seed 42

. qddml $Y (c.($X)# #c($X)) ($D=$Z), kfolds(5) model(interactiveiv) cmd(pystacked) ycmdopt(type(reg) m(lassocv)) dcmdopt(t
> ype(class) m(lassocv)) zcmdopt(type(class) m(lassocv))
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized
Learner Y1_pystacked added successfully.
Learner D1_pystacked added successfully.
Learner Z1_pystacked added successfully.
shortstack  requested but must have multiple learners in all equations; option ignored
Cross-fitting E[y|X,Z] equation: earnings
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[D|X,Z] equation: training
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[Z|X]: assignmt
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting


Model:                  late, crossfit folds k=5, resamples r=1
Dependent variable (Y): earnings
 earnings learners:     Y1_pystacked
D equations (1):        training
 training learners:     D1_pystacked
Z equations (1):        assignmt
 assignmt learners:     Z1_pystacked

DDML estimation results (LATE):
spec  r  Y(0) learner  Y(1) learner  D(0) learner  D(1) learner         b        SE      Z learner
   1  1  Y1_pystacked  Y1_pystacked  D1_pystacked  D1_pystacked  1824.216  (514.244)  Z1_pystacked

DDML model (LATE)
E[y|X,D=0]   = Y1_pystacked0_1                     Number of obs   =     11204
E[y|X,D=1]   = Y1_pystacked1_1
E[D|X,Z=0]   = D1_pystacked0_1
E[D|X,Z=1]   = D1_pystacked1_1
E[Z|X]       = Z1_pystacked_1
------------------------------------------------------------------------------
             |               Robust
    earnings |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    training |   1824.216   514.2438     3.55   0.000     816.3162    2832.115
------------------------------------------------------------------------------


. local b2 = _b[$D]

. 
. assert reldif(`b1',`b2')<$tol

. 
. **** FIV
. 
. use https://github.com/aahrens1/ddml/raw/master/data/BLP.dta, clear

. global Y share

. global D price

. global X hpwt air mpd space

. global Z sum*

. 
. set seed 42

. ddml init fiv
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. ddml E[Y|X]: pystacked $Y $X, type(reg)
Learner Y1_pystacked added successfully.

. ddml E[D|Z,X], learner(Dhat_pystacked): pystacked $D $X $Z, type(reg)
Learner Dhat_pystacked added successfully.

. ddml E[D|X], learner(Dhat_pystacked) vname($D): pystacked {D} $X, type(reg)
Learner Dhat_pystacked_h added successfully.

. ddml crossfit
Cross-fitting E[y|X,Z] equation: share
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[D|X,Z] and E[D|X] equation: price
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting

. ddml estimate


Model:                  fiv, crossfit folds k=5, resamples r=1
Dependent variable (Y): share
 share learners:        Y1_pystacked
D equations (1):        price
 price learners:        Dhat_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE     DH learner
  st  1  Y1_pystacked Dhat_pystac~d    -0.098    (0.008) Dhat_pystac~h

Stacking DDML model
y-E[y|X]  = y-Y1_pystacked_1                       Number of obs   =      2217
E[D|X,Z]  = D-Dhat_pystacked_1 
E[D^|X]   = Dhat_pystacked_h_1
Orthogonalized D = D - E[D^|X]; optimal IV = E[D|X,Z] - E[D^|X].
------------------------------------------------------------------------------
       share |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.0978842   .0079847   -12.26   0.000     -.113534   -.0822344
       _cons |   .0032566   .0215635     0.15   0.880    -.0390072    .0455204
------------------------------------------------------------------------------


. local b1 = _b[$D]

. 
. set seed 42

. qddml $Y ($X) ($D=$Z), model(fiv) cmd(pystacked) cmdopt(type(reg))
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized
Learner Y1_pystacked added successfully.
Learner D1_pystacked added successfully.
Learner D1_pystacked_h added successfully.
shortstack  requested but must have multiple learners in all equations; option ignored
Cross-fitting E[y|X,Z] equation: share
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[D|X,Z] and E[D|X] equation: price
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting


Model:                  fiv, crossfit folds k=5, resamples r=1
Dependent variable (Y): share
 share learners:        Y1_pystacked
D equations (1):        price
 price learners:        D1_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE     DH learner
  st  1  Y1_pystacked  D1_pystacked    -0.098    (0.008) D1_pystacke~h

Stacking DDML model
y-E[y|X]  = y-Y1_pystacked_1                       Number of obs   =      2217
E[D|X,Z]  = D-D1_pystacked_1 
E[D^|X]   = D1_pystacked_h_1
Orthogonalized D = D - E[D^|X]; optimal IV = E[D|X,Z] - E[D^|X].
------------------------------------------------------------------------------
       share |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.0978842   .0079847   -12.26   0.000     -.113534   -.0822344
       _cons |   .0032566   .0215635     0.15   0.880    -.0390072    .0455204
------------------------------------------------------------------------------


. local b2 = _b[$D]

. 
. assert reldif(`b1',`b2')<$tol

. 
. log close
      name:  <unnamed>
       log:  C:\LocalStore\ecomes\Documents\GitHub\ddml\cert\qddml_cert.log
  log type:  text
 closed on:   8 Jul 2023, 23:03:57
--------------------------------------------------------------------------------------------------------------------------
