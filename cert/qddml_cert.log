--------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\LocalStore\ecomes\Documents\GitHub\ddml\cert\qddml_cert.log
  log type:  text
 opened on:  11 Jul 2023, 16:51:56

. 
. * global tol = 0.0001
. which ddml
C:\LocalStore\ecomes\Documents\GitHub\ddml\ddml.ado
*! ddml v1.2
*! last edited: 8 july 2023
*! authors: aa/ms

. which pystacked
C:\LocalStore\ecomes\Documents\GitHub\pystacked\pystacked.ado
*! pystacked v0.7.2
*! last edited: 8july2023
*! authors: aa/ms

. 
. **** Partially linear model w/pystacked integration
. 
. use https://github.com/aahrens1/ddml/raw/master/data/sipp1991.dta, clear

. global Y net_tfa

. global D e401

. global X tw age inc fsize educ db marr twoearn pira hown

. 
. set seed 42

. ddml init partial, kfolds(2)

. ddml E[Y|X]: pystacked $Y $X, type(reg)
Learner Y1_pystacked added successfully.

. ddml E[D|X]: pystacked $D $X, type(reg)
Learner D1_pystacked added successfully.

. // ddml reports only standard stacking by default
. ddml crossfit, shortstack
Cross-fitting E[y|X] equation: net_tfa
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking
Cross-fitting E[D|X] equation: e401
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking

. ddml estimate


Model:                  partial, crossfit folds k=2, resamples r=1
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_pystacked
D equations (1):        e401
 e401 learners:         D1_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE 
  st  1  Y1_pystacked  D1_pystacked  6544.681  (824.506)
  ss  1  [shortstack]          [ss]  6992.984  (804.595)

Shortstack DDML model
y-E[y|X]  = y-Y_net_tfa_ss_1                       Number of obs   =      9915
D-E[D|X]  = D-D_e401_ss_1 
------------------------------------------------------------------------------
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   6992.984   804.5954     8.69   0.000     5416.006    8569.962
       _cons |  -10.65561    356.163    -0.03   0.976    -708.7223    687.4111
------------------------------------------------------------------------------


. global b1_ss = _b[$D]

. ddml estimate, mname(m0) spec(st) rep(1) notable replay

Stacking DDML model
y-E[y|X]  = y-Y1_pystacked_1                       Number of obs   =      9915
D-E[D|X]  = D-D1_pystacked_1 
------------------------------------------------------------------------------
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   6544.681   824.5058     7.94   0.000      4928.68    8160.683
       _cons |   51.38852    365.049     0.14   0.888    -664.0943    766.8714
------------------------------------------------------------------------------


. global b1_std = _b[$D]

. 
. set seed 42

. // qddml reports only short-stacking by default
. qddml $Y $D ($X), kfolds(2) model(partial) stdstack shortstack mname(m0q)
Learner Y1_pystacked added successfully.
Learner D1_pystacked added successfully.
Cross-fitting E[y|X] equation: net_tfa
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking
Cross-fitting E[D|X] equation: e401
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking


Model:                  partial, crossfit folds k=2, resamples r=1
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_pystacked
D equations (1):        e401
 e401 learners:         D1_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE 
  st  1  Y1_pystacked  D1_pystacked  6544.681  (824.506)
  ss  1  [shortstack]          [ss]  6992.984  (804.595)

Shortstack DDML model
y-E[y|X]  = y-Y_net_tfa_ss_1                       Number of obs   =      9915
D-E[D|X]  = D-D_e401_ss_1 
------------------------------------------------------------------------------
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   6992.984   804.5954     8.69   0.000     5416.006    8569.962
       _cons |  -10.65561    356.163    -0.03   0.976    -708.7223    687.4111
------------------------------------------------------------------------------


. global b2_ss = _b[$D]

. ddml estimate, mname(m0q) spec(st) rep(1) notable replay

Stacking DDML model
y-E[y|X]  = y-Y1_pystacked_1                       Number of obs   =      9915
D-E[D|X]  = D-D1_pystacked_1 
------------------------------------------------------------------------------
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   6544.681   824.5058     7.94   0.000      4928.68    8160.683
       _cons |   51.38852    365.049     0.14   0.888    -664.0943    766.8714
------------------------------------------------------------------------------


. global b2_std = _b[$D]

. 
. assert reldif($b1_ss, $b2_ss)  < 10e-10

. assert reldif($b1_std,$b2_std) < 10e-10

. 
. **** Partially linear IV model, rforest
. 
. use https://statalasso.github.io/dta/AJR.dta, clear

. global Y logpgp95

. global D avexpr

. global Z logem4

. global X lat_abst edes1975 avelf temp* humid* steplow-oilres

. 
. set seed 42

. ddml init iv, kfolds(30)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. ddml E[Y|X], vtype(none): rforest $Y $X, type(reg)
Learner Y1_rforest added successfully.

. ddml E[D|X], vtype(none): rforest $D $X, type(reg)
Learner D1_rforest added successfully.

. ddml E[Z|X], vtype(none): rforest $Z $X, type(reg)
Learner Z1_rforest added successfully.

. ddml crossfit
Cross-fitting E[y|X] equation: logpgp95
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting
Cross-fitting E[D|X] equation: avexpr
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting
Cross-fitting E[Z|X]: logem4
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting

. ddml estimate, robust


Model:                  iv, crossfit folds k=30, resamples r=1
Dependent variable (Y): logpgp95
 logpgp95 learners:     Y1_rforest
D equations (1):        avexpr
 avexpr learners:       D1_rforest
Z equations (1):        logem4
 logem4 learners:       Z1_rforest

DDML estimation results:
spec  r     Y learner     D learner         b        SE      Z learner
   1  1    Y1_rforest    D1_rforest     0.772    (0.207)    Z1_rforest

DDML model
y-E[y|X]  = y-Y1_rforest_1                         Number of obs   =        64
D-E[D|X]  = D-D1_rforest_1 
Z-E[Z|X]  = Z-Z1_rforest_1 
------------------------------------------------------------------------------
             |               Robust
    logpgp95 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      avexpr |   .7723141   .2068282     3.73   0.000     .3669382     1.17769
       _cons |  -.0119092    .100929    -0.12   0.906    -.2097263    .1859079
------------------------------------------------------------------------------


. global b1 = _b[$D]

. 
. set seed 42

. qddml $Y ($X) ($D=$Z), kfolds(30) model(iv) mname(m0q)          ///
>         cmd(rforest) cmdopt(type(reg)) vtype(none) robust
warning - model m0q already exists
all existing model results and variables will
be dropped and model m0q will be re-initialized
Learner Y1_rforest added successfully.
Learner D1_rforest added successfully.
Learner Z1_rforest added successfully.
shortstack  requested but must have multiple learners in all equations; option ignored
Cross-fitting E[y|X] equation: logpgp95
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting
Cross-fitting E[D|X] equation: avexpr
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting
Cross-fitting E[Z|X]: logem4
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-fit
> ting


Model:                  iv, crossfit folds k=30, resamples r=1
Dependent variable (Y): logpgp95
 logpgp95 learners:     Y1_rforest
D equations (1):        avexpr
 avexpr learners:       D1_rforest
Z equations (1):        logem4
 logem4 learners:       Z1_rforest

DDML estimation results:
spec  r     Y learner     D learner         b        SE      Z learner
   1  1    Y1_rforest    D1_rforest     0.772    (0.207)    Z1_rforest

DDML model
y-E[y|X]  = y-Y1_rforest_1                         Number of obs   =        64
D-E[D|X]  = D-D1_rforest_1 
Z-E[Z|X]  = Z-Z1_rforest_1 
------------------------------------------------------------------------------
             |               Robust
    logpgp95 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      avexpr |   .7723141   .2068282     3.73   0.000     .3669382     1.17769
       _cons |  -.0119092    .100929    -0.12   0.906    -.2097263    .1859079
------------------------------------------------------------------------------


. global b2 = _b[$D]

. 
. assert reldif($b1,$b2) < 10e-10

. 
. **** Interactive model--ATE and ATET estimation w/pystacked integration
. 
. webuse cattaneo2, clear
(Excerpt from Cattaneo (2010) Journal of Econometrics 155: 138-154)

. keep in 1/1000
(3,642 observations deleted)

. global Y bweight

. global D mbsmoke

. global X mage prenatal1 mmarried fbaby mage medu

. global pystacked_y_options type(reg) method(rf gradboost)

. global pystacked_d_options type(class) method(rf gradboost)

. 
. set seed 42

. ddml init interactive, kfolds(2) reps(2)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. ddml E[Y|X,D]: pystacked $Y $X, $pystacked_y_options
Learner Y1_pystacked added successfully.

. ddml E[D|X]: pystacked $D $X, $pystacked_d_options
Learner D1_pystacked added successfully.

. // ddml reports only standard stacking by default
. ddml crossfit, shortstack
Cross-fitting E[y|X,D] equation: bweight
Resample 1...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking
Resample 2...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking
Cross-fitting E[D|X] equation: mbsmoke
Resample 1...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking
Resample 2...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking

. ddml estimate


Model:                  interactive, crossfit folds k=2, resamples r=2
Dependent variable (Y): bweight
 bweight learners:      Y1_pystacked
D equations (1):        mbsmoke
 mbsmoke learners:      D1_pystacked

DDML estimation results (ATE):
spec  r  Y(0) learner  Y(1) learner     D learner         b        SE 
  st  1  Y1_pystacked  Y1_pystacked  D1_pystacked  -302.581  (208.715)
  ss  1  [shortstack]          [ss]          [ss]  -369.423  (234.493)
  st  2  Y1_pystacked  Y1_pystacked  D1_pystacked   -14.721  (217.713)
  ss  2  [shortstack]          [ss]          [ss]     2.798  (225.992)

Mean/med Y(0) learner  Y(1) learner     D learner         b        SE 
 mse mn     [min-mse]         [mse]         [mse]  -158.651  (257.178)
  ss mn  [shortstack]          [ss]          [ss]  -183.312  (296.012)
 mse md     [min-mse]         [mse]         [mse]  -158.651  (257.286)
  ss md  [shortstack]          [ss]          [ss]  -183.312  (296.086)

Shortstack DDML model (median over 2 resamples) (ATE)
E[y|X,D=0]   = Y_bweight_ss0                       Number of obs   =      1000
E[y|X,D=1]   = Y_bweight_ss1
E[D|X]       = D_mbsmoke_ss
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |  -183.3125   296.0859    -0.62   0.536    -763.6302    397.0053
------------------------------------------------------------------------------
Warning: 2 resamples had propensity scores trimmed to lower limit .01.

Summary over 2 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -183.3125 -369.4231 -369.4231 -183.3125    2.7982    2.7982

. global b1_md_ss                 = _b[$D]

. ddml estimate, mname(m0) spec(st) rep(md) notable replay

Median over 2 stacking resamples (ATE)
E[y|X,D=0]   = Y1_pystacked0                       Number of obs   =      1000
E[y|X,D=1]   = Y1_pystacked1
E[D|X]       = D1_pystacked
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |   -158.651   257.2864    -0.62   0.537     -662.923     345.621
------------------------------------------------------------------------------
Warning: 2 resamples had propensity scores trimmed to lower limit .01.

Summary over 2 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -158.6510 -302.5814 -302.5814 -158.6510  -14.7205  -14.7205

. global b1_md_std                = _b[$D]

. ddml estimate, atet


Model:                  interactive, crossfit folds k=2, resamples r=2
Dependent variable (Y): bweight
 bweight learners:      Y1_pystacked
D equations (1):        mbsmoke
 mbsmoke learners:      D1_pystacked

DDML estimation results (ATET):
spec  r  Y(0) learner  Y(1) learner     D learner         b        SE 
  st  1  Y1_pystacked  Y1_pystacked  D1_pystacked  -333.961   (78.438)
  ss  1  [shortstack]          [ss]          [ss]  -332.007   (78.204)
  st  2  Y1_pystacked  Y1_pystacked  D1_pystacked  -187.400  (236.523)
  ss  2  [shortstack]          [ss]          [ss]    24.879  (422.828)

Mean/med Y(0) learner  Y(1) learner     D learner         b        SE 
 mse mn     [min-mse]         [mse]         [mse]  -260.681  (139.282)
  ss mn  [shortstack]          [ss]          [ss]  -153.564  (253.621)
 mse md     [min-mse]         [mse]         [mse]  -260.681  (190.835)
  ss md  [shortstack]          [ss]          [ss]  -153.564  (352.551)

Shortstack DDML model (median over 2 resamples) (ATET)
E[y|X,D=0]   = Y_bweight_ss0                       Number of obs   =      1000
E[y|X,D=1]   = Y_bweight_ss1
E[D|X]       = D_mbsmoke_ss
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |   -153.564   352.5506    -0.44   0.663    -844.5504    537.4225
------------------------------------------------------------------------------
Warning: 2 resamples had propensity scores trimmed to lower limit .01.

Summary over 2 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -153.5640 -332.0074 -332.0074 -153.5640   24.8795   24.8795

. global b1_atet_md_ss    = _b[$D]

. ddml estimate, mname(m0) spec(st) rep(md) notable replay

Median over 2 stacking resamples (ATET)
E[y|X,D=0]   = Y1_pystacked0                       Number of obs   =      1000
E[y|X,D=1]   = Y1_pystacked1
E[D|X]       = D1_pystacked
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |  -260.6806   190.8349    -1.37   0.172    -634.7102     113.349
------------------------------------------------------------------------------
Warning: 2 resamples had propensity scores trimmed to lower limit .01.

Summary over 2 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -260.6806 -333.9614 -333.9614 -260.6806 -187.3998 -187.3998

. global b1_atet_md_std   = _b[$D]

. 
. set seed 42

. // qddml reports only short-stacking by default
. qddml $Y $D ($X), kfolds(2) reps(2) model(interactive)          ///
>         mname(m0q)                                                                                              ///
>         stdstack shortstack                                                                             ///
>         pystacked_y($pystacked_y_options)                                               ///
>         pystacked_d($pystacked_d_options)
warning - model m0q already exists
all existing model results and variables will
be dropped and model m0q will be re-initialized
Learner Y1_pystacked added successfully.
Learner D1_pystacked added successfully.
Cross-fitting E[y|X,D] equation: bweight
Resample 1...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking
Resample 2...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking
Cross-fitting E[D|X] equation: mbsmoke
Resample 1...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking
Resample 2...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking


Model:                  interactive, crossfit folds k=2, resamples r=2
Dependent variable (Y): bweight
 bweight learners:      Y1_pystacked
D equations (1):        mbsmoke
 mbsmoke learners:      D1_pystacked

DDML estimation results (ATE):
spec  r  Y(0) learner  Y(1) learner     D learner         b        SE 
  st  1  Y1_pystacked  Y1_pystacked  D1_pystacked  -302.581  (208.715)
  ss  1  [shortstack]          [ss]          [ss]  -369.423  (234.493)
  st  2  Y1_pystacked  Y1_pystacked  D1_pystacked   -14.721  (217.713)
  ss  2  [shortstack]          [ss]          [ss]     2.798  (225.992)

Mean/med Y(0) learner  Y(1) learner     D learner         b        SE 
 mse mn     [min-mse]         [mse]         [mse]  -158.651  (257.178)
  ss mn  [shortstack]          [ss]          [ss]  -183.312  (296.012)
 mse md     [min-mse]         [mse]         [mse]  -158.651  (257.286)
  ss md  [shortstack]          [ss]          [ss]  -183.312  (296.086)

Shortstack DDML model (median over 2 resamples) (ATE)
E[y|X,D=0]   = Y_bweight_ss0                       Number of obs   =      1000
E[y|X,D=1]   = Y_bweight_ss1
E[D|X]       = D_mbsmoke_ss
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |  -183.3125   296.0859    -0.62   0.536    -763.6302    397.0053
------------------------------------------------------------------------------
Warning: 2 resamples had propensity scores trimmed to lower limit .01.

Summary over 2 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -183.3125 -369.4231 -369.4231 -183.3125    2.7982    2.7982

. global b2_md_ss                 = _b[$D]

. ddml estimate, mname(m0q) spec(st) rep(md) notable replay

Median over 2 stacking resamples (ATE)
E[y|X,D=0]   = Y1_pystacked0                       Number of obs   =      1000
E[y|X,D=1]   = Y1_pystacked1
E[D|X]       = D1_pystacked
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |   -158.651   257.2864    -0.62   0.537     -662.923     345.621
------------------------------------------------------------------------------
Warning: 2 resamples had propensity scores trimmed to lower limit .01.

Summary over 2 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -158.6510 -302.5814 -302.5814 -158.6510  -14.7205  -14.7205

. global b2_md_std                = _b[$D]

. ddml estimate, atet mname(m0q)


Model:                  interactive, crossfit folds k=2, resamples r=2
Dependent variable (Y): bweight
 bweight learners:      Y1_pystacked
D equations (1):        mbsmoke
 mbsmoke learners:      D1_pystacked

DDML estimation results (ATET):
spec  r  Y(0) learner  Y(1) learner     D learner         b        SE 
  st  1  Y1_pystacked  Y1_pystacked  D1_pystacked  -333.961   (78.438)
  ss  1  [shortstack]          [ss]          [ss]  -332.007   (78.204)
  st  2  Y1_pystacked  Y1_pystacked  D1_pystacked  -187.400  (236.523)
  ss  2  [shortstack]          [ss]          [ss]    24.879  (422.828)

Mean/med Y(0) learner  Y(1) learner     D learner         b        SE 
 mse mn     [min-mse]         [mse]         [mse]  -260.681  (139.282)
  ss mn  [shortstack]          [ss]          [ss]  -153.564  (253.621)
 mse md     [min-mse]         [mse]         [mse]  -260.681  (190.835)
  ss md  [shortstack]          [ss]          [ss]  -153.564  (352.551)

Shortstack DDML model (median over 2 resamples) (ATET)
E[y|X,D=0]   = Y_bweight_ss0                       Number of obs   =      1000
E[y|X,D=1]   = Y_bweight_ss1
E[D|X]       = D_mbsmoke_ss
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |   -153.564   352.5506    -0.44   0.663    -844.5504    537.4225
------------------------------------------------------------------------------
Warning: 2 resamples had propensity scores trimmed to lower limit .01.

Summary over 2 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -153.5640 -332.0074 -332.0074 -153.5640   24.8795   24.8795

. global b2_atet_md_ss    = _b[$D]

. ddml estimate, mname(m0q) spec(st) rep(md) notable replay

Median over 2 stacking resamples (ATET)
E[y|X,D=0]   = Y1_pystacked0                       Number of obs   =      1000
E[y|X,D=1]   = Y1_pystacked1
E[D|X]       = D1_pystacked
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |  -260.6806   190.8349    -1.37   0.172    -634.7102     113.349
------------------------------------------------------------------------------
Warning: 2 resamples had propensity scores trimmed to lower limit .01.

Summary over 2 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -260.6806 -333.9614 -333.9614 -260.6806 -187.3998 -187.3998

. global b2_atet_md_std   = _b[$D]

. 
. assert reldif($b1_md_ss,       $b2_md_ss)       < 10e-10

. assert reldif($b1_md_std,      $b2_md_std)      < 10e-10

. assert reldif($b1_atet_md_ss,  $b2_atet_md_ss)  < 10e-10

. assert reldif($b1_atet_md_std, $b2_atet_md_std) < 10e-10

. 
. **** Interactive IV model w/pystacked integration
. 
. use http://fmwww.bc.edu/repec/bocode/j/jtpa.dta,clear

. global Y earnings

. global D training

. global Z assignmt

. global X sex age married black hispanic

. global pystacked_y_options type(reg) m(lassocv)

. global pystacked_d_options type(class) m(lassocv)

. global pystacked_z_options type(class) m(lassocv)

. 
. set seed 42

. ddml init interactiveiv, kfolds(5)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. ddml E[Y|X,Z]: pystacked $Y c.($X)# #c($X), $pystacked_y_options
Learner Y1_pystacked added successfully.

. ddml E[D|X,Z]: pystacked $D c.($X)# #c($X), $pystacked_d_options
Learner D1_pystacked added successfully.

. ddml E[Z|X]: pystacked $Z c.($X)# #c($X), $pystacked_z_options
Learner Z1_pystacked added successfully.

. ddml crossfit
Cross-fitting E[y|X,Z] equation: earnings
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[D|X,Z] equation: training
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[Z|X]: assignmt
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting

. ddml estimate


Model:                  late, crossfit folds k=5, resamples r=1
Dependent variable (Y): earnings
 earnings learners:     Y1_pystacked
D equations (1):        training
 training learners:     D1_pystacked
Z equations (1):        assignmt
 assignmt learners:     Z1_pystacked

DDML estimation results (LATE):
spec  r  Y(0) learner  Y(1) learner  D(0) learner  D(1) learner         b        SE      Z learner
   1  1  Y1_pystacked  Y1_pystacked  D1_pystacked  D1_pystacked  1824.216  (514.244)  Z1_pystacked

DDML model (LATE)
E[y|X,D=0]   = Y1_pystacked0_1                     Number of obs   =     11204
E[y|X,D=1]   = Y1_pystacked1_1
E[D|X,Z=0]   = D1_pystacked0_1
E[D|X,Z=1]   = D1_pystacked1_1
E[Z|X]       = Z1_pystacked_1
------------------------------------------------------------------------------
             |               Robust
    earnings |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    training |   1824.216   514.2438     3.55   0.000     816.3162    2832.115
------------------------------------------------------------------------------


. global b1 = _b[$D]

. 
. set seed 42

. qddml $Y (c.($X)# #c($X)) ($D=$Z), kfolds(5) model(interactiveiv)       ///
>         mname(m0q)                                                                                                      
>         ///
>         pystacked_y($pystacked_y_options)                                                               ///
>         pystacked_d($pystacked_d_options)                                                               ///
>         pystacked_z($pystacked_z_options)
warning - model m0q already exists
all existing model results and variables will
be dropped and model m0q will be re-initialized
Learner Y1_pystacked added successfully.
Learner D1_pystacked added successfully.
Learner Z1_pystacked added successfully.
shortstack  requested but must have multiple learners in all equations; option ignored
Cross-fitting E[y|X,Z] equation: earnings
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[D|X,Z] equation: training
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[Z|X]: assignmt
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting


Model:                  late, crossfit folds k=5, resamples r=1
Dependent variable (Y): earnings
 earnings learners:     Y1_pystacked
D equations (1):        training
 training learners:     D1_pystacked
Z equations (1):        assignmt
 assignmt learners:     Z1_pystacked

DDML estimation results (LATE):
spec  r  Y(0) learner  Y(1) learner  D(0) learner  D(1) learner         b        SE      Z learner
   1  1  Y1_pystacked  Y1_pystacked  D1_pystacked  D1_pystacked  1824.216  (514.244)  Z1_pystacked

DDML model (LATE)
E[y|X,D=0]   = Y1_pystacked0_1                     Number of obs   =     11204
E[y|X,D=1]   = Y1_pystacked1_1
E[D|X,Z=0]   = D1_pystacked0_1
E[D|X,Z=1]   = D1_pystacked1_1
E[Z|X]       = Z1_pystacked_1
------------------------------------------------------------------------------
             |               Robust
    earnings |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    training |   1824.216   514.2438     3.55   0.000     816.3162    2832.115
------------------------------------------------------------------------------


. global b2 = _b[$D]

. 
. assert reldif($b1,$b2) < 10e-10

. 
. **** FIV
. 
. use https://github.com/aahrens1/ddml/raw/master/data/BLP.dta, clear

. global Y share

. global D price

. global X hpwt air mpd space

. global Z sum*

. 
. set seed 42

. ddml init fiv
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. ddml E[Y|X]: pystacked $Y $X, type(reg)
Learner Y1_pystacked added successfully.

. ddml E[D|Z,X], learner(Dhat_pystacked): pystacked $D $X $Z, type(reg)
Learner Dhat_pystacked added successfully.

. ddml E[D|X], learner(Dhat_pystacked) vname($D): pystacked {D} $X, type(reg)
Learner Dhat_pystacked_h added successfully.

. ddml crossfit
Cross-fitting E[y|X,Z] equation: share
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[D|X,Z] and E[D|X] equation: price
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting

. ddml estimate


Model:                  fiv, crossfit folds k=5, resamples r=1
Dependent variable (Y): share
 share learners:        Y1_pystacked
D equations (1):        price
 price learners:        Dhat_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE     DH learner
  st  1  Y1_pystacked Dhat_pystac~d    -0.098    (0.008) Dhat_pystac~h

Stacking DDML model
y-E[y|X]  = y-Y1_pystacked_1                       Number of obs   =      2217
E[D|X,Z]  = D-Dhat_pystacked_1 
E[D^|X]   = Dhat_pystacked_h_1
Orthogonalized D = D - E[D^|X]; optimal IV = E[D|X,Z] - E[D^|X].
------------------------------------------------------------------------------
       share |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.0978842   .0079847   -12.26   0.000     -.113534   -.0822344
       _cons |   .0032566   .0215635     0.15   0.880    -.0390072    .0455204
------------------------------------------------------------------------------


. global b1 = _b[$D]

. 
. set seed 42

. qddml $Y ($X) ($D=$Z), model(fiv) cmd(pystacked) cmdopt(type(reg))
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized
Learner Y1_pystacked added successfully.
Learner D1_pystacked added successfully.
Learner D1_pystacked_h added successfully.
shortstack  requested but must have multiple learners in all equations; option ignored
Cross-fitting E[y|X,Z] equation: share
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[D|X,Z] and E[D|X] equation: price
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting


Model:                  fiv, crossfit folds k=5, resamples r=1
Dependent variable (Y): share
 share learners:        Y1_pystacked
D equations (1):        price
 price learners:        D1_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE     DH learner
  st  1  Y1_pystacked  D1_pystacked    -0.098    (0.008) D1_pystacke~h

Stacking DDML model
y-E[y|X]  = y-Y1_pystacked_1                       Number of obs   =      2217
E[D|X,Z]  = D-D1_pystacked_1 
E[D^|X]   = D1_pystacked_h_1
Orthogonalized D = D - E[D^|X]; optimal IV = E[D|X,Z] - E[D^|X].
------------------------------------------------------------------------------
       share |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.0978842   .0079847   -12.26   0.000     -.113534   -.0822344
       _cons |   .0032566   .0215635     0.15   0.880    -.0390072    .0455204
------------------------------------------------------------------------------


. global b2 = _b[$D]

. 
. assert reldif($b1,$b2) < 10e-10

. 
. log close
      name:  <unnamed>
       log:  C:\LocalStore\ecomes\Documents\GitHub\ddml\cert\qddml_cert.log
  log type:  text
 closed on:  11 Jul 2023, 16:55:35
--------------------------------------------------------------------------------------------------------------------------
