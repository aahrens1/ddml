-----------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\LocalStore\ecomes\Documents\GitHub\ddml\cert\ddml_cert.log
  log type:  text
 opened on:  28 Jul 2023, 13:30:49

. 
. // net install ddml, from(https://raw.githubusercontent.com/aahrens1/ddml/dev/) replace
. 
. // necessary programs for cert; script exits with error if not installed
. findfile pystacked.ado
C:\LocalStore\ecomes\Documents\GitHub\pystacked/pystacked.ado

. findfile svmachines.ado
C:\LocalStore\ecomes\ado\plus/s/svmachines.ado

. findfile rforest.ado
C:\LocalStore\ecomes\ado\plus/r/rforest.ado

. 
. global tol = 0.0001

. which ddml
C:\LocalStore\ecomes\Documents\GitHub\ddml\ddml.ado
*! ddml v1.4
*! last edited: 27july2023
*! authors: aa/ms

. which pystacked
C:\LocalStore\ecomes\Documents\GitHub\pystacked\pystacked.ado
*! pystacked v0.7.4
*! last edited: 23july2023
*! authors: aa/ms

. 
. 
. ******************************************************************************** 
. **** Partially-linear model                                                                                          
>            ****
. ******************************************************************************** 
. 
. use https://github.com/aahrens1/ddml/raw/master/data/sipp1991.dta, clear

. global Y net_tfa

. global D e401

. global X tw age inc fsize educ db marr twoearn pira hown

. set seed 42

. 
. sample 30 
(6,940 observations deleted)

. 
. ddml init partial, kfolds(2) 

. 
. ddml E[Y|X]: reg $Y $X
Learner Y1_reg added successfully.

. ddml E[Y|X]: pystacked $Y $X, type(reg) method(rf gradboost)
Learner Y2_pystacked added successfully.

. ddml E[Y|X]: svmachines $Y $X, type(svr)
Learner Y3_svmachines added successfully.

. ddml E[D|X]: reg $D $X
Learner D1_reg added successfully.

. ddml E[D|X]: pystacked $D $X, type(reg) method(rf gradboost)
Learner D2_pystacked added successfully.

. ddml E[D|X]: svmachines $D $X, type(svr)
Learner D3_svmachines added successfully.

. // add eqn if parsnip installed
. cap findfile parsnip2.ado

. local hasparsnip=_rc

. cap findfile parsnip.ado

. local hasparsnip=`hasparsnip'+_rc

. if `hasparsnip'==0 {
.         ddml E[D|X]: parsnip2 $D $X, model(linear_reg) engine(glmnet) penalty(.5) clearR
. }

. ddml desc

Model:                  partial, crossfit folds k=2, resamples r=1
Mata global (mname):    m0
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_reg Y2_pystacked Y3_svmachines
D equations (1):        e401
 e401 learners:         D1_reg D2_pystacked D3_svmachines

. 
. ddml crossfit 
Cross-fitting E[y|X] equation: net_tfa
Cross-fitting fold 1 2 ...completed cross-fitting
Cross-fitting E[D|X] equation: e401
Cross-fitting fold 1 2 ...completed cross-fitting

. 
. ddml estimate, robust


Model:                  partial, crossfit folds k=2, resamples r=1
Mata global (mname):    m0
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_reg Y2_pystacked Y3_svmachines
D equations (1):        e401
 e401 learners:         D1_reg D2_pystacked D3_svmachines

DDML estimation results:
spec  r     Y learner     D learner         b        SE 
 mse  1  Y2_pystacked  D2_pystacked  4261.284 (1690.627)
mse = minimum MSE specification for that resample.

Min MSE DDML model
y-E[y|X]  = y-Y2_pystacked_1                       Number of obs   =      2975
D-E[D|X]  = D-D2_pystacked_1 
------------------------------------------------------------------------------
             |               Robust
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   4261.284   1690.627     2.52   0.012     947.7153    7574.853
       _cons |  -110.1049   592.9702    -0.19   0.853    -1272.305    1052.095
------------------------------------------------------------------------------


. local b1=_b[e401]

. cap drop Y_

. cap drop D_

. gen double Y_ = $Y - Y2_pystacked_1

. gen double D_ = $D - D2_pystacked_1

. reg Y_ D_, robust

Linear regression                               Number of obs     =      2,975
                                                F(1, 2973)        =       6.35
                                                Prob > F          =     0.0118
                                                R-squared         =     0.0034
                                                Root MSE          =      32352

------------------------------------------------------------------------------
             |               Robust
          Y_ |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          D_ |   4261.284   1690.627     2.52   0.012     946.3657    7576.202
       _cons |  -110.1049   592.9702    -0.19   0.853    -1272.778    1052.569
------------------------------------------------------------------------------

. local b2=_b[D_]

. assert reldif(`b1',`b2')<$tol

. 
. ddml estimate, robust allcombos


Model:                  partial, crossfit folds k=2, resamples r=1
Mata global (mname):    m0
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_reg Y2_pystacked Y3_svmachines
D equations (1):        e401
 e401 learners:         D1_reg D2_pystacked D3_svmachines

DDML estimation results:
spec  r     Y learner     D learner         b        SE 
   1  1        Y1_reg        D1_reg  2583.611 (2384.652)
   2  1        Y1_reg  D2_pystacked  5573.862 (1834.809)
   3  1        Y1_reg D3_svmachines  2897.301 (1459.457)
   4  1  Y2_pystacked        D1_reg  4632.367 (1828.453)
*  5  1  Y2_pystacked  D2_pystacked  4261.284 (1690.627)
   6  1  Y2_pystacked D3_svmachines  4304.172 (1299.624)
   7  1 Y3_svmachines        D1_reg  2750.802 (4315.982)
   8  1 Y3_svmachines  D2_pystacked  6617.978 (3288.265)
   9  1 Y3_svmachines D3_svmachines 21762.880 (2510.777)
* = minimum MSE specification for that resample.

Min MSE DDML model
y-E[y|X]  = y-Y2_pystacked_1                       Number of obs   =      2975
D-E[D|X]  = D-D2_pystacked_1 
------------------------------------------------------------------------------
             |               Robust
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   4261.284   1690.627     2.52   0.012     947.7153    7574.853
       _cons |  -110.1049   592.9702    -0.19   0.853    -1272.305    1052.095
------------------------------------------------------------------------------


. 
. ddml extract, show(mse)

MSEs for e401:
                 rep   full smp      fold 1      fold 2 
          D1_reg   1      0.195       0.192       0.197  
    D2_pystacked   1      0.194       0.190       0.199  
   D3_svmachines   1      0.232       0.233       0.232  

MSEs for net_tfa:
                 rep   full smp      fold 1      fold 2 
          Y1_reg   1  1.446e+09   1.616e+09   1.276e+09  
    Y2_pystacked   1  1.049e+09   1.072e+09   1.027e+09  
   Y3_svmachines   1  4.365e+09   5.148e+09   3.584e+09  

. ddml extract, show(n)

Sample sizes for e401:
                 rep   full smp      fold 1      fold 2 
          D1_reg   1       2975        1487        1488  
    D2_pystacked   1       2975        1487        1488  
   D3_svmachines   1       2975        1487        1488  

Sample sizes for net_tfa:
                 rep   full smp      fold 1      fold 2 
          Y1_reg   1       2975        1487        1488  
    Y2_pystacked   1       2975        1487        1488  
   Y3_svmachines   1       2975        1487        1488  

. 
. ddml drop 

. 
. // check that everything was deleted
. cap ddml desc

. assert _rc==3259

. 
. // pystacked as a single learner with multiple base learners;
. // shortstacking; multiple reps; ddml extract
. ddml init partial, kfolds(2) reps(2)

. 
. ddml E[Y|X]: pystacked $Y $X, type(reg) method(rf gradboost)
Learner Y1_pystacked added successfully.

. ddml E[D|X]: pystacked $D $X, type(reg) method(rf gradboost)
Learner D1_pystacked added successfully.

. ddml desc

Model:                  partial, crossfit folds k=2, resamples r=2
Mata global (mname):    m0
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_pystacked
D equations (1):        e401
 e401 learners:         D1_pystacked

. 
. ddml crossfit, shortstack
Cross-fitting E[y|X] equation: net_tfa
Resample 1...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking
Resample 2...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking
Cross-fitting E[D|X] equation: e401
Resample 1...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking
Resample 2...
Cross-fitting fold 1 2 ...completed cross-fitting...completed short-stacking

. 
. ddml estimate, robust


Model:                  partial, crossfit folds k=2, resamples r=2
Mata global (mname):    m0
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_pystacked
D equations (1):        e401
 e401 learners:         D1_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE 
  st  1  Y1_pystacked  D1_pystacked  5033.885 (1672.782)
  ss  1  [shortstack]          [ss]  4993.057 (1668.641)
  st  2  Y1_pystacked  D1_pystacked  6499.283 (1379.506)
  ss  2  [shortstack]          [ss]  6168.030 (1396.827)

Mean/med    Y learner     D learner         b        SE 
  st mn  Y1_pystacked  D1_pystacked  5766.584 (1678.716)
  ss mn  [shortstack]          [ss]  5580.543 (1627.545)
  st md  Y1_pystacked  D1_pystacked  5766.584 (1699.254)
  ss md  [shortstack]          [ss]  5580.543 (1647.084)

Shortstack DDML model (median over 2 resamples)
y-E[y|X]  = y-Y_net_tfa_ss                         Number of obs   =      2975
D-E[D|X]  = D-D_e401_ss 
------------------------------------------------------------------------------
             |               Robust
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   5580.543   1647.084     3.39   0.001     2352.319    8808.768
------------------------------------------------------------------------------
Stacking final estimator: nnls1

Summary over 2 resamples:
       D eqn      mean       min       p25       p50       p75       max
        e401   5580.5432 4993.0566 4993.0566 5580.5432 6168.0298 6168.0298

. 
. ddml extract, show(pystacked)

pystacked weights for D1_pystacked (e401)
             learner   resample     fold_1     fold_2
       rf          1          1   .1126649  .22399065
gradboost          2          1   .8873351  .77600935
       rf          1          2  .29168375    .213625
gradboost          2          2  .70831625    .786375

mean stacking weights across folds/resamples for D1_pystacked (e401)
final stacking estimator: nnls1
               learner  mean_weight        rep_1        rep_2
       rf            1    .21049108    .16832777    .25265438
gradboost            2    .78950892    .83167223    .74734562

pystacked MSEs for D1_pystacked (e401)
             learner   resample     fold_1     fold_2
       rf          1          1  .21122083  .20771264
gradboost          2          1  .19914561  .19824936
       rf          1          2  .20666499  .21143806
gradboost          2          2  .19962547  .20203662

mean stacking MSEs across folds/resamples for D1_pystacked (e401)
final stacking estimator: nnls1
             learner   mean_MSE      rep_1      rep_2
       rf          1  .20925913  .20946674  .20905152
gradboost          2  .19976427  .19869748  .20083105

pystacked weights for Y1_pystacked (net_tfa)
             learner   resample     fold_1     fold_2
       rf          1          1   .4663139  .69734919
gradboost          2          1   .5336861  .30265081
       rf          1          2  2.042e-12          1
gradboost          2          2          1          0

mean stacking weights across folds/resamples for Y1_pystacked (net_tfa)
final stacking estimator: nnls1
               learner  mean_weight        rep_1        rep_2
       rf            1    .54091577    .58183154           .5
gradboost            2    .45908423    .41816846           .5

pystacked MSEs for Y1_pystacked (net_tfa)
             learner   resample     fold_1     fold_2
       rf          1          1  1.566e+09  7.135e+08
gradboost          2          1  1.549e+09  7.460e+08
       rf          1          2  1.431e+09  1.340e+09
gradboost          2          2  1.309e+09  1.547e+09

mean stacking MSEs across folds/resamples for Y1_pystacked (net_tfa)
final stacking estimator: nnls1
             learner   mean_MSE      rep_1      rep_2
       rf          1  1.263e+09  1.140e+09  1.386e+09
gradboost          2  1.288e+09  1.148e+09  1.428e+09

. ddml extract, show(weights)

mean stacking weights across folds/resamples for D1_pystacked (e401)
final stacking estimator: nnls1
               learner  mean_weight        rep_1        rep_2
       rf            1    .21049108    .16832777    .25265438
gradboost            2    .78950892    .83167223    .74734562

mean stacking weights across folds/resamples for Y1_pystacked (net_tfa)
final stacking estimator: nnls1
               learner  mean_weight        rep_1        rep_2
       rf            1    .54091577    .58183154           .5
gradboost            2    .45908423    .41816846           .5

short-stacked weights across resamples for e401
final stacking estimator: nnls1
               learner  mean_weight        rep_1        rep_2
       rf            1     .1621664    .20859716    .11573564
gradboost            2     .8378336    .79140284    .88426436

short-stacked weights across resamples for net_tfa
final stacking estimator: nnls1
               learner  mean_weight        rep_1        rep_2
       rf            1    .42790978     .3372394    .51858017
gradboost            2    .57209022     .6627606    .48141983

error - pool-stacked weights for e401 not available

error - pool-stacked weights for net_tfa not available

. 
. ******************************************************************************** 
. **** Partially-linear IV model                                                                                  ****
. ******************************************************************************** 
. 
. 
. use https://statalasso.github.io/dta/AJR.dta, clear

. global Y logpgp95

. global D avexpr

. global Z logem4

. global X lat_abst edes1975 avelf temp* humid* steplow-oilres

. set seed 42

. 
. ddml init iv, kfolds(30)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. 
. ddml E[Y|X]: reg $Y $X
Learner Y1_reg added successfully.

. ddml E[Y|X], vtype(none): rforest $Y $X, type(reg)
Learner Y2_rforest added successfully.

. ddml E[D|X]: reg $D $X
Learner D1_reg added successfully.

. ddml E[D|X], vtype(none): rforest $D $X, type(reg)
Learner D2_rforest added successfully.

. ddml E[Z|X]: reg $Z $X
Learner Z1_reg added successfully.

. ddml E[Z|X], vtype(none): rforest $Z $X, type(reg)
Learner Z2_rforest added successfully.

. 
. ddml crossfit
Cross-fitting E[y|X] equation: logpgp95
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-
> fitting
Cross-fitting E[D|X] equation: avexpr
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-
> fitting
Cross-fitting E[Z|X]: logem4
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-
> fitting

. ddml estimate, robust


Model:                  iv, crossfit folds k=30, resamples r=1
Mata global (mname):    m0
Dependent variable (Y): logpgp95
 logpgp95 learners:     Y1_reg Y2_rforest
D equations (1):        avexpr
 avexpr learners:       D1_reg D2_rforest
Z equations (1):        logem4
 logem4 learners:       Z1_reg Z2_rforest

DDML estimation results:
spec  r     Y learner     D learner         b        SE      Z learner
 mse  1    Y2_rforest    D2_rforest     0.772    (0.207)    Z2_rforest
mse = minimum MSE specification for that resample.

Min MSE DDML model
y-E[y|X]  = y-Y2_rforest_1                         Number of obs   =        64
D-E[D|X]  = D-D2_rforest_1 
Z-E[Z|X]  = Z-Z2_rforest_1 
------------------------------------------------------------------------------
             |               Robust
    logpgp95 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      avexpr |   .7723141   .2068282     3.73   0.000     .3669382     1.17769
       _cons |  -.0119092    .100929    -0.12   0.906    -.2097263    .1859079
------------------------------------------------------------------------------


. local a = _b[ave]

. 
. cap drop Y_

. cap drop D_

. cap drop Z_

. gen double Y_ = $Y - Y2_rforest_1

. gen double D_ = $D - D2_rforest_1

. gen double Z_ = $Z - Z2_rforest_1

. ivreg Y_ (D_ = Z_) , robust

Instrumental variables (2SLS) regression        Number of obs     =         64
                                                F(1, 62)          =      13.94
                                                Prob > F          =     0.0004
                                                R-squared         =          .
                                                Root MSE          =     .80209

------------------------------------------------------------------------------
             |               Robust
          Y_ |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          D_ |   .7723141   .2068282     3.73   0.000     .3588704    1.185758
       _cons |  -.0119092    .100929    -0.12   0.906    -.2136633    .1898449
------------------------------------------------------------------------------
Instrumented:  D_
Instruments:   Z_
------------------------------------------------------------------------------

. local b = _b[D_]

. assert reldif(`a',`b')<$tol

. 
. 
. ******************************************************************************** 
. **** Partially-linear IV model with multiple treatments                                 ****
. ******************************************************************************** 
. 
. 
. use https://statalasso.github.io/dta/AJR.dta, clear

. global Y logpgp95

. global D1 avexpr

. global D2 democ1

. global Z1 logem4

. global Z2 lat_abst 

. global X edes1975 avelf temp* humid* steplow-oilres

. set seed 42

. 
. ddml init iv, kfolds(30)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. 
. ddml E[Y|X]: reg $Y $X
Learner Y1_reg added successfully.

. ddml E[D|X]: reg $D1 $X
Learner D1_reg added successfully.

. ddml E[D|X]: reg $D2 $X
Learner D2_reg added successfully.

. ddml E[Z|X]: reg $Z1 $X
Learner Z1_reg added successfully.

. ddml E[Z|X]: reg $Z2 $X
Learner Z2_reg added successfully.

. 
. ddml crossfit
Cross-fitting E[y|X] equation: logpgp95
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-
> fitting
Cross-fitting E[D|X] equation: avexpr
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-
> fitting
Cross-fitting E[D|X] equation: democ1
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-
> fitting
Cross-fitting E[Z|X]: logem4
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-
> fitting
Cross-fitting E[Z|X]: lat_abst
Cross-fitting fold 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 ...completed cross-
> fitting

. 
. ddml estimate, robust


Model:                  iv, crossfit folds k=30, resamples r=1
Mata global (mname):    m0
Dependent variable (Y): logpgp95
 logpgp95 learners:     Y1_reg
D equations (2):        avexpr democ1
 avexpr learners:       D1_reg
 democ1 learners:       D2_reg
Z equations (2):        logem4 lat_abst
 logem4 learners:       Z1_reg
 lat_abst learners:     Z2_reg

DDML estimation results:
spec  r     Y learner     D learner         b        SE      D learner         b        SE      Z learner     Z learner
   1  1        Y1_reg        D1_reg     0.208    (0.054)        D2_reg    -0.021    (0.103)        Z1_reg        Z2_reg

DDML model
y-E[y|X]  = y-Y1_reg_1                             Number of obs   =        59
D-E[D|X]  = D1-D1_reg_1 D2-D2_reg_1 
Z-E[Z|X]  = Z1-Z1_reg_1 Z2-Z2_reg_1 
------------------------------------------------------------------------------
             |               Robust
    logpgp95 |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      avexpr |   .2080151   .0541917     3.84   0.000     .1018013    .3142288
      democ1 |  -.0205451    .103233    -0.20   0.842     -.222878    .1817878
       _cons |  -.0417427   .1116813    -0.37   0.709     -.260634    .1771485
------------------------------------------------------------------------------


. local a1 = _b[ave]

. local a2 = _b[demo]

. 
. ddml extract, show(mse)

MSEs for avexpr:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5      fold 6      fold 7    
>   fold 8      fold 9     fold 10     fold 11     fold 12     fold 13     fold 14     fold 15     fold 16     fold 17 
>     fold 18     fold 19     fold 20     fold 21     fold 22     fold 23     fold 24     fold 25     fold 26     fold 
> 27     fold 28     fold 29     fold 30 
          D1_reg   1     10.603       1.271       1.927       6.434       4.235       3.836       1.439       1.657    
>    0.723       0.796       3.891       0.239       6.346       0.796       0.058       2.745      11.843       1.659 
>       0.852       0.972       1.166       2.344       6.531      10.546       1.037     173.476       3.385       1.4
> 49      71.987       6.756       1.262  

MSEs for democ1:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5      fold 6      fold 7    
>   fold 8      fold 9     fold 10     fold 11     fold 12     fold 13     fold 14     fold 15     fold 16     fold 17 
>     fold 18     fold 19     fold 20     fold 21     fold 22     fold 23     fold 24     fold 25     fold 26     fold 
> 27     fold 28     fold 29     fold 30 
          D2_reg   1     26.244      46.292       6.328      25.617           .      90.304       2.483       8.646    
>   15.236      21.068       4.282       7.079      15.009      11.699      28.087      47.129       3.727       1.839 
>       5.464      80.509      15.095       0.304       1.993      12.779      23.572       0.673       8.380      24.8
> 80     154.949      82.720       7.878  

MSEs for lat_abst:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5      fold 6      fold 7    
>   fold 8      fold 9     fold 10     fold 11     fold 12     fold 13     fold 14     fold 15     fold 16     fold 17 
>     fold 18     fold 19     fold 20     fold 21     fold 22     fold 23     fold 24     fold 25     fold 26     fold 
> 27     fold 28     fold 29     fold 30 
          Z2_reg   1      0.031       0.001       0.004       0.071       0.005       0.002       0.006       0.002    
>    0.040       0.021       0.019       0.003       0.004       0.000       0.066       0.012       0.034       0.001 
>       0.004       0.014       0.001       0.004       0.004       0.003       0.002       0.496       0.007       0.0
> 02       0.109       0.008       0.006  

MSEs for logem4:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5      fold 6      fold 7    
>   fold 8      fold 9     fold 10     fold 11     fold 12     fold 13     fold 14     fold 15     fold 16     fold 17 
>     fold 18     fold 19     fold 20     fold 21     fold 22     fold 23     fold 24     fold 25     fold 26     fold 
> 27     fold 28     fold 29     fold 30 
          Z1_reg   1      1.738       4.175       0.911       2.816       5.553       2.345       0.511       0.194    
>    0.349       0.221       0.519       3.131       1.736       0.337       1.070       0.606       0.449       2.593 
>       0.082       0.080       0.797       0.583       0.229       1.288       0.262       7.791       0.658       0.1
> 15      11.990       1.361       1.154  

MSEs for logpgp95:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5      fold 6      fold 7    
>   fold 8      fold 9     fold 10     fold 11     fold 12     fold 13     fold 14     fold 15     fold 16     fold 17 
>     fold 18     fold 19     fold 20     fold 21     fold 22     fold 23     fold 24     fold 25     fold 26     fold 
> 27     fold 28     fold 29     fold 30 
          Y1_reg   1      1.592       0.611       0.000       0.990       3.994       0.439       0.410       0.095    
>    0.611       0.049       0.802       0.175       2.967       0.262       0.283       0.541       0.749       2.292 
>       0.303       1.860       0.340       0.299       0.079       0.997       0.919       9.250       0.297       0.1
> 42      10.239       8.964       0.597  

. ddml extract, show(n)

Sample sizes for avexpr:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5      fold 6      fold 7    
>   fold 8      fold 9     fold 10     fold 11     fold 12     fold 13     fold 14     fold 15     fold 16     fold 17 
>     fold 18     fold 19     fold 20     fold 21     fold 22     fold 23     fold 24     fold 25     fold 26     fold 
> 27     fold 28     fold 29     fold 30 
          D1_reg   1         64           2           2           2           2           2           2           2    
>        3           2           2           2           2           2           2           3           2           2 
>           2           2           2           2           2           3           2           2           2          
>  2           2           2           3  

Sample sizes for democ1:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5      fold 6      fold 7    
>   fold 8      fold 9     fold 10     fold 11     fold 12     fold 13     fold 14     fold 15     fold 16     fold 17 
>     fold 18     fold 19     fold 20     fold 21     fold 22     fold 23     fold 24     fold 25     fold 26     fold 
> 27     fold 28     fold 29     fold 30 
          D2_reg   1         59           2           2           1           0           2           2           2    
>        2           2           2           2           2           2           2           3           2           1 
>           2           2           2           2           2           3           2           2           2          
>  2           2           2           3  

Sample sizes for lat_abst:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5      fold 6      fold 7    
>   fold 8      fold 9     fold 10     fold 11     fold 12     fold 13     fold 14     fold 15     fold 16     fold 17 
>     fold 18     fold 19     fold 20     fold 21     fold 22     fold 23     fold 24     fold 25     fold 26     fold 
> 27     fold 28     fold 29     fold 30 
          Z2_reg   1         64           2           2           2           2           2           2           2    
>        3           2           2           2           2           2           2           3           2           2 
>           2           2           2           2           2           3           2           2           2          
>  2           2           2           3  

Sample sizes for logem4:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5      fold 6      fold 7    
>   fold 8      fold 9     fold 10     fold 11     fold 12     fold 13     fold 14     fold 15     fold 16     fold 17 
>     fold 18     fold 19     fold 20     fold 21     fold 22     fold 23     fold 24     fold 25     fold 26     fold 
> 27     fold 28     fold 29     fold 30 
          Z1_reg   1         64           2           2           2           2           2           2           2    
>        3           2           2           2           2           2           2           3           2           2 
>           2           2           2           2           2           3           2           2           2          
>  2           2           2           3  

Sample sizes for logpgp95:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5      fold 6      fold 7    
>   fold 8      fold 9     fold 10     fold 11     fold 12     fold 13     fold 14     fold 15     fold 16     fold 17 
>     fold 18     fold 19     fold 20     fold 21     fold 22     fold 23     fold 24     fold 25     fold 26     fold 
> 27     fold 28     fold 29     fold 30 
          Y1_reg   1         64           2           2           2           2           2           2           2    
>        3           2           2           2           2           2           2           3           2           2 
>           2           2           2           2           2           3           2           2           2          
>  2           2           2           3  

. 
. cap drop Y_

. cap drop D_1 D_2

. cap drop Z_1 Z_2

. gen double Y_ = $Y - Y1_reg_1

. gen double D_1 = $D1 - D1_reg_1

. gen double D_2 = $D2 - D2_reg_1
(5 missing values generated)

. gen double Z_1 = $Z1 - Z1_reg_1

. gen double Z_2 = $Z2 - Z2_reg_1

. ivreg Y_ (D_1 D_2 = Z_1 Z_2) , robust

Instrumental variables (2SLS) regression        Number of obs     =         59
                                                F(2, 56)          =      14.39
                                                Prob > F          =     0.0000
                                                R-squared         =     0.5441
                                                Root MSE          =     .84387

------------------------------------------------------------------------------
             |               Robust
          Y_ |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         D_1 |   .2080151   .0541917     3.84   0.000     .0994561    .3165741
         D_2 |  -.0205451    .103233    -0.20   0.843    -.2273456    .1862554
       _cons |  -.0417427   .1116813    -0.37   0.710    -.2654672    .1819817
------------------------------------------------------------------------------
Instrumented:  D_1 D_2
Instruments:   Z_1 Z_2
------------------------------------------------------------------------------

. local b1 = _b[D_1]

. local b2 = _b[D_2]

. assert reldif(`a1',`b1')<$tol

. assert reldif(`a2',`b2')<$tol

. 
. 
. ******************************************************************************** 
. **** Partially-linear model with repetitions                                                            ****
. ******************************************************************************** 
. 
. use https://github.com/aahrens1/ddml/raw/master/data/sipp1991.dta, clear

. global Y net_tfa

. global D e401

. global X tw age inc fsize educ db marr twoearn pira hown

. set seed 42

. 
. sample 30 
(6,940 observations deleted)

. 
. ddml init partial, kfolds(2) reps(3)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. 
. ddml E[Y|X]: reg $Y $X
Learner Y1_reg added successfully.

. ddml E[Y|X]: pystacked $Y $X, type(reg) method(rf)
Learner Y2_pystacked added successfully.

. ddml E[D|X]: reg $D $X
Learner D1_reg added successfully.

. ddml E[D|X]: pystacked $D $X, type(reg) method(rf)
Learner D2_pystacked added successfully.

. 
. ddml crossfit 
Cross-fitting E[y|X] equation: net_tfa
Cross-fitting fold 1 2 ...completed cross-fitting
Cross-fitting fold 1 2 ...completed cross-fitting
Cross-fitting fold 1 2 ...completed cross-fitting
Cross-fitting E[D|X] equation: e401
Cross-fitting fold 1 2 ...completed cross-fitting
Cross-fitting fold 1 2 ...completed cross-fitting
Cross-fitting fold 1 2 ...completed cross-fitting

. ddml estimate, robust


Model:                  partial, crossfit folds k=2, resamples r=3
Mata global (mname):    m0
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_reg Y2_pystacked
D equations (1):        e401
 e401 learners:         D1_reg D2_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE 
 mse  1  Y2_pystacked        D1_reg  4410.228 (1872.850)
 mse  2  Y2_pystacked        D1_reg  6055.082 (2027.102)
 mse  3  Y2_pystacked        D1_reg  3441.027 (2680.635)
mse = minimum MSE specification for that resample.

Mean/med    Y learner     D learner         b        SE 
 mse mn     [min-mse]     [min-mse]  4635.446 (2313.676)
 mse md     [min-mse]     [min-mse]  4410.228 (2610.495)

Median over 3 min-mse resamples
y-E[y|X]  = y-Y2_pystacked                         Number of obs   =      2975
D-E[D|X]  = D-D1_reg 
------------------------------------------------------------------------------
             |               Robust
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   4410.228   2610.495     1.69   0.091    -706.2472    9526.704
------------------------------------------------------------------------------

Summary over 3 resamples:
       D eqn      mean       min       p25       p50       p75       max
        e401   4635.4458 3441.0273 3441.0273 4410.2285 6055.0815 6055.0815

. 
. ddml estimate, robust allcombos  


Model:                  partial, crossfit folds k=2, resamples r=3
Mata global (mname):    m0
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_reg Y2_pystacked
D equations (1):        e401
 e401 learners:         D1_reg D2_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE 
   1  1        Y1_reg        D1_reg  2583.611 (2384.652)
   2  1        Y1_reg  D2_pystacked  5909.586 (1554.454)
*  3  1  Y2_pystacked        D1_reg  4410.228 (1872.850)
   4  1  Y2_pystacked  D2_pystacked  4689.415 (1443.570)
   1  2        Y1_reg        D1_reg  3063.781 (2411.957)
   2  2        Y1_reg  D2_pystacked  5517.316 (1612.397)
*  3  2  Y2_pystacked        D1_reg  6055.082 (2027.102)
   4  2  Y2_pystacked  D2_pystacked  5716.340 (1413.183)
   1  3        Y1_reg        D1_reg  1217.534 (2823.359)
   2  3        Y1_reg  D2_pystacked  5567.672 (1603.926)
*  3  3  Y2_pystacked        D1_reg  3441.027 (2680.635)
   4  3  Y2_pystacked  D2_pystacked  5411.646 (1434.303)
* = minimum MSE specification for that resample.

Mean/med    Y learner     D learner         b        SE 
 mse mn     [min-mse]     [min-mse]  4635.446 (2313.676)
 mse md     [min-mse]     [min-mse]  4410.228 (2610.495)

Median over 3 min-mse resamples
y-E[y|X]  = y-Y2_pystacked                         Number of obs   =      2975
D-E[D|X]  = D-D1_reg 
------------------------------------------------------------------------------
             |               Robust
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   4410.228   2610.495     1.69   0.091    -706.2472    9526.704
------------------------------------------------------------------------------

Summary over 3 resamples:
       D eqn      mean       min       p25       p50       p75       max
        e401   4635.4458 3441.0273 3441.0273 4410.2285 6055.0815 6055.0815

. ddml estimate, spec(3) rep(1) notable replay 

Min MSE DDML model, specification 3 (sample=1)
y-E[y|X]  = y-Y2_pystacked_1                       Number of obs   =      2975
D-E[D|X]  = D-D1_reg_1 
------------------------------------------------------------------------------
             |               Robust
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   4410.228    1872.85     2.35   0.019     739.5092    8080.948
       _cons |  -787.5462   596.7172    -1.32   0.187     -1957.09    381.9981
------------------------------------------------------------------------------


. cap drop bhat

. gen bhat=.
(2,975 missing values generated)

. replace bhat = _b[e401] if _n==1
(1 real change made)

. ddml estimate, spec(3) rep(2) notable replay 

Min MSE DDML model, specification 3 (sample=2)
y-E[y|X]  = y-Y2_pystacked_2                       Number of obs   =      2975
D-E[D|X]  = D-D1_reg_2 
------------------------------------------------------------------------------
             |               Robust
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   6055.082   2027.102     2.99   0.003     2082.036    10028.13
       _cons |  -1092.678   585.8575    -1.87   0.062    -2240.938    55.58126
------------------------------------------------------------------------------


. replace bhat = _b[e401] if _n==2
(1 real change made)

. ddml estimate, spec(3) rep(3) notable replay 

Min MSE DDML model, specification 3 (sample=3)
y-E[y|X]  = y-Y2_pystacked_3                       Number of obs   =      2975
D-E[D|X]  = D-D1_reg_3 
------------------------------------------------------------------------------
             |               Robust
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   3441.027   2680.635     1.28   0.199     -1812.92    8694.975
       _cons |  -125.9623   639.3725    -0.20   0.844    -1379.109    1127.185
------------------------------------------------------------------------------


. replace bhat = _b[e401] if _n==3
(1 real change made)

. 
. ddml estimate, spec(mse) rep(md) notable replay 

Median over 3 min-mse resamples
y-E[y|X]  = y-Y2_pystacked                         Number of obs   =      2975
D-E[D|X]  = D-D1_reg 
------------------------------------------------------------------------------
             |               Robust
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   4410.228   2610.495     1.69   0.091    -706.2472    9526.704
------------------------------------------------------------------------------

Summary over 3 resamples:
       D eqn      mean       min       p25       p50       p75       max
        e401   4635.4458 3441.0273 3441.0273 4410.2285 6055.0815 6055.0815

. local bmedian =_b[e401]

. sum bhat, detail

                            bhat
-------------------------------------------------------------
      Percentiles      Smallest
 1%     3441.027       3441.027
 5%     3441.027       4410.229
10%     3441.027       6055.082       Obs                   3
25%     3441.027              .       Sum of Wgt.           3

50%     4410.229                      Mean           4635.446
                        Largest       Std. Dev.        1321.5
75%     6055.082              .
90%     6055.082       3441.027       Variance        1746362
95%     6055.082       4410.229       Skewness       .3039979
99%     6055.082       6055.082       Kurtosis            1.5

. assert reldif(`r(p50)',`bmedian')<$tol

. 
. ddml estimate, spec(mse) rep(mn) notable replay 

Mean over 3 min-mse resamples
y-E[y|X]  = y-Y2_pystacked                         Number of obs   =      2975
D-E[D|X]  = D-D1_reg 
------------------------------------------------------------------------------
             |               Robust
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   4635.446   2313.676     2.00   0.045     100.7244    9170.167
------------------------------------------------------------------------------

Summary over 3 resamples:
       D eqn      mean       min       p25       p50       p75       max
        e401   4635.4458 3441.0273 3441.0273 4410.2285 6055.0815 6055.0815

. local bmean =_b[e401]

. sum bhat, detail

                            bhat
-------------------------------------------------------------
      Percentiles      Smallest
 1%     3441.027       3441.027
 5%     3441.027       4410.229
10%     3441.027       6055.082       Obs                   3
25%     3441.027              .       Sum of Wgt.           3

50%     4410.229                      Mean           4635.446
                        Largest       Std. Dev.        1321.5
75%     6055.082              .
90%     6055.082       3441.027       Variance        1746362
95%     6055.082       4410.229       Skewness       .3039979
99%     6055.082       6055.082       Kurtosis            1.5

. assert reldif(`r(mean)',`bmean')<$tol

. 
. ******************************************************************************** 
. **** Partially-linear model with 2 treatments                                                           ****
. ******************************************************************************** 
. 
. use https://github.com/aahrens1/ddml/raw/master/data/sipp1991.dta, clear

. global Y net_tfa

. global D1 e401

. global D2 educ

. global X tw age inc fsize db marr twoearn pira hown

. set seed 42

. 
. sample 30 
(6,940 observations deleted)

. 
. ddml init partial, kfolds(2)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. 
. ddml E[Y|X]: reg $Y $X
Learner Y1_reg added successfully.

. ddml E[Y|X]: pystacked $Y $X, type(reg) method(rf lassocv)
Learner Y2_pystacked added successfully.

. ddml E[D|X]: reg $D1 $X
Learner D1_reg added successfully.

. ddml E[D|X]: pystacked $D1 $X, type(reg) method(rf lassocv)
Learner D2_pystacked added successfully.

. ddml E[D|X]: reg $D2 $X
Learner D3_reg added successfully.

. ddml E[D|X]: pystacked $D2 $X, type(reg) method(rf lassocv )
Learner D4_pystacked added successfully.

. 
. ddml crossfit 
Cross-fitting E[y|X] equation: net_tfa
Cross-fitting fold 1 2 ...completed cross-fitting
Cross-fitting E[D|X] equation: e401
Cross-fitting fold 1 2 ...completed cross-fitting
Cross-fitting E[D|X] equation: educ
Cross-fitting fold 1 2 ...completed cross-fitting

. 
. ddml estimate, robust 


Model:                  partial, crossfit folds k=2, resamples r=1
Mata global (mname):    m0
Dependent variable (Y): net_tfa
 net_tfa learners:      Y1_reg Y2_pystacked
D equations (2):        e401 educ
 e401 learners:         D1_reg D2_pystacked
 educ learners:         D3_reg D4_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE      D learner         b        SE 
 mse  1  Y2_pystacked  D2_pystacked  4557.893 (1845.947)  D4_pystacked   159.851  (343.149)
mse = minimum MSE specification for that resample.

Min MSE DDML model
y-E[y|X]  = y-Y2_pystacked_1                       Number of obs   =      2975
D-E[D|X]  = D1-D2_pystacked_1 D2-D4_pystacked_1 
------------------------------------------------------------------------------
             |               Robust
     net_tfa |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        e401 |   4557.893   1845.947     2.47   0.014     939.9041    8175.882
        educ |   159.8515   343.1493     0.47   0.641    -512.7088    832.4117
       _cons |  -331.1816   582.9518    -0.57   0.570    -1473.746     811.383
------------------------------------------------------------------------------


. local a1 = _b[e401]

. local a2 = _b[educ]

. local a3 = _b[_cons]

. cap drop Y_

. cap drop D_1

. cap drop D_2

. gen Y_ = $Y - Y2_pystacked_1

. gen D_1 = $D1 - D2_pystacked_1

. gen D_2 = $D2 - D4_pystacked_1

. reg Y_ D_1 D_2,robust

Linear regression                               Number of obs     =      2,975
                                                F(2, 2972)        =       3.42
                                                Prob > F          =     0.0328
                                                R-squared         =     0.0041
                                                Root MSE          =      31738

------------------------------------------------------------------------------
             |               Robust
          Y_ |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         D_1 |   4557.893   1845.947     2.47   0.014     938.4301    8177.356
         D_2 |   159.8515   343.1493     0.47   0.641    -512.9828    832.6857
       _cons |  -331.1816   582.9518    -0.57   0.570    -1474.212    811.8485
------------------------------------------------------------------------------

. local b1 = _b[D_1]

. local b2 = _b[D_2]

. local b3 = _b[_cons]

. assert reldif(`a1',`b1')<$tol

. assert reldif(`a2',`b2')<$tol

. assert reldif(`a3',`b3')<$tol

. 
. ddml extract, show(mse)

MSEs for e401:
                 rep   full smp      fold 1      fold 2 
          D1_reg   1      0.195       0.192       0.197  
    D2_pystacked   1      0.193       0.191       0.195  

MSEs for educ:
                 rep   full smp      fold 1      fold 2 
          D3_reg   1      5.834       5.956       5.712  
    D4_pystacked   1      5.685       5.746       5.625  

MSEs for net_tfa:
                 rep   full smp      fold 1      fold 2 
          Y1_reg   1  1.431e+09   1.610e+09   1.252e+09  
    Y2_pystacked   1  1.011e+09   1.060e+09   9.614e+08  

. ddml extract, show(n)

Sample sizes for e401:
                 rep   full smp      fold 1      fold 2 
          D1_reg   1       2975        1487        1488  
    D2_pystacked   1       2975        1487        1488  

Sample sizes for educ:
                 rep   full smp      fold 1      fold 2 
          D3_reg   1       2975        1487        1488  
    D4_pystacked   1       2975        1487        1488  

Sample sizes for net_tfa:
                 rep   full smp      fold 1      fold 2 
          Y1_reg   1       2975        1487        1488  
    Y2_pystacked   1       2975        1487        1488  

. 
. 
. ******************************************************************************** 
. **** Interactive model--ATE and ATET estimation.                                                        ****
. ******************************************************************************** 
. 
. webuse cattaneo2, clear
(Excerpt from Cattaneo (2010) Journal of Econometrics 155: 138-154)

. global Y bweight

. global D mbsmoke

. global X mage prenatal1 mmarried fbaby mage medu

. set seed 42

. 
. sample 30
(3,249 observations deleted)

. 
. ddml init interactive, kfolds(5) reps(5)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. 
. ddml E[Y|X,D]: reg $Y $X
Learner Y1_reg added successfully.

. ddml E[Y|X,D]: pystacked $Y $X, type(reg) method(gradboost rf)
Learner Y2_pystacked added successfully.

. ddml E[D|X]: logit $D $X
Learner D1_logit added successfully.

. ddml E[D|X]: pystacked $D $X, type(class) method(gradboost rf)
Learner D2_pystacked added successfully.

. ddml E[D|X]: svmachines $D $X, type(svc) 
Learner D3_svmachines added successfully.

. 
. ddml crossfit, shortstack
Cross-fitting E[y|X,D] equation: bweight
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting E[D|X] equation: mbsmoke
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking

. 
. ddml estimate


Model:                  interactive, crossfit folds k=5, resamples r=5
Mata global (mname):    m0
Dependent variable (Y): bweight
 bweight learners:      Y1_reg Y2_pystacked
D equations (1):        mbsmoke
 mbsmoke learners:      D1_logit D2_pystacked D3_svmachines

DDML estimation results (ATE):
spec  r  Y(0) learner  Y(1) learner     D learner         b        SE 
 mse  1        Y1_reg        Y1_reg  D2_pystacked  -291.099   (70.144)
  ss  1  [shortstack]          [ss]          [ss]  -258.388   (43.915)
 mse  2        Y1_reg        Y1_reg      D1_logit  -247.569   (39.568)
  ss  2  [shortstack]          [ss]          [ss]  -254.203   (41.667)
 mse  3        Y1_reg        Y1_reg  D2_pystacked  -297.615   (72.460)
  ss  3  [shortstack]          [ss]          [ss]  -264.242   (46.142)
 mse  4        Y1_reg        Y1_reg      D1_logit  -250.521   (38.664)
  ss  4  [shortstack]          [ss]          [ss]  -257.968   (42.209)
 mse  5        Y1_reg        Y1_reg      D1_logit  -245.722   (39.219)
  ss  5  [shortstack]          [ss]          [ss]  -247.478   (41.950)
mse = minimum MSE specification for that resample.

Mean/med Y(0) learner  Y(1) learner     D learner         b        SE 
 mse mn     [min-mse]     [min-mse]     [min-mse]  -266.505   (50.762)
  ss mn  [shortstack]          [ss]          [ss]  -256.456   (43.417)
 mse md     [min-mse]     [min-mse]     [min-mse]  -250.521   (39.678)
  ss md  [shortstack]          [ss]          [ss]  -257.968   (43.242)

Shortstack DDML model (median over 5 resamples) (ATE)
E[y|X,D=0]   = Y_bweight_ss0                       Number of obs   =      1393
E[y|X,D=1]   = Y_bweight_ss1
E[D|X]       = D_mbsmoke_ss
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |  -257.9682   43.24165    -5.97   0.000    -342.7202   -173.2161
------------------------------------------------------------------------------
Stacking final estimator: nnls1

Summary over 5 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -256.4559 -264.2422 -258.3879 -257.9681 -254.2035 -247.4776

. ddml estimate, atet trim(0)


Model:                  interactive, crossfit folds k=5, resamples r=5
Mata global (mname):    m0
Dependent variable (Y): bweight
 bweight learners:      Y1_reg Y2_pystacked
D equations (1):        mbsmoke
 mbsmoke learners:      D1_logit D2_pystacked D3_svmachines

DDML estimation results (ATET):
spec  r  Y(0) learner  Y(1) learner     D learner         b        SE 
 mse  1        Y1_reg        Y1_reg  D2_pystacked  -187.206   (46.082)
  ss  1  [shortstack]          [ss]          [ss]  -183.686   (40.936)
 mse  2        Y1_reg        Y1_reg      D1_logit  -186.027   (41.622)
  ss  2  [shortstack]          [ss]          [ss]  -186.850   (41.996)
 mse  3        Y1_reg        Y1_reg  D2_pystacked  -184.638   (44.976)
  ss  3  [shortstack]          [ss]          [ss]  -187.789   (40.974)
 mse  4        Y1_reg        Y1_reg      D1_logit  -198.433   (40.670)
  ss  4  [shortstack]          [ss]          [ss]  -192.602   (40.783)
 mse  5        Y1_reg        Y1_reg      D1_logit  -196.062   (41.295)
  ss  5  [shortstack]          [ss]          [ss]  -200.010   (40.872)
mse = minimum MSE specification for that resample.

Mean/med Y(0) learner  Y(1) learner     D learner         b        SE 
 mse mn     [min-mse]     [min-mse]     [min-mse]  -190.473   (43.165)
  ss mn  [shortstack]          [ss]          [ss]  -190.187   (41.493)
 mse md     [min-mse]     [min-mse]     [min-mse]  -187.206   (42.234)
  ss md  [shortstack]          [ss]          [ss]  -187.789   (41.141)

Shortstack DDML model (median over 5 resamples) (ATET)
E[y|X,D=0]   = Y_bweight_ss0                       Number of obs   =      1393
E[y|X,D=1]   = Y_bweight_ss1
E[D|X]       = D_mbsmoke_ss
------------------------------------------------------------------------------
             |               Robust
     bweight |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     mbsmoke |  -187.7886   41.14114    -4.56   0.000    -268.4237   -107.1534
------------------------------------------------------------------------------
Stacking final estimator: nnls1

Summary over 5 resamples:
       D eqn      mean       min       p25       p50       p75       max
     mbsmoke   -190.1873 -200.0097 -192.6018 -187.7886 -186.8501 -183.6863

. 
. ddml extract, show(mse)

MSEs for bweight:
                D=  rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
          Y1_reg 0    1 324817.889  280990.616  349722.734  297318.651  313477.900  380214.232  
          Y1_reg 1    1 259569.688  231501.271  279282.333  217793.031  228701.493  343847.097  
          Y1_reg 0    2 326141.281  303386.564  339599.919  388291.873  284516.889  314918.818  
          Y1_reg 1    2 264259.544  245003.545  235205.513  235308.194  384466.949  236948.994  
          Y1_reg 0    3 324837.099  380869.614  332834.915  310170.969  259928.590  338054.590  
          Y1_reg 1    3 263172.789  356372.869  247274.217  235290.178  313225.691  183535.662  
          Y1_reg 0    4 325559.281  326913.693  318764.331  315412.845  317542.571  349893.922  
          Y1_reg 1    4 257225.931  253071.593  195450.548  164465.316  293049.952  358928.578  
          Y1_reg 0    5 325039.936  307874.323  373240.116  339599.912  273927.080  332383.140  
          Y1_reg 1    5 266320.916  245518.844  215136.602  273925.019  324087.030  283078.780  
    Y2_pystacked 0    1 348652.743  294207.523  397459.019  307304.280  324632.384  416668.751  
    Y2_pystacked 1    1 339428.095  282590.141  301581.725  298317.197  452072.872  374918.975  
    Y2_pystacked 0    2 338409.942  330043.550  354073.364  381268.555  289799.206  337670.147  
    Y2_pystacked 1    2 304151.386  262780.166  324338.051  280694.955  370445.959  289608.434  
    Y2_pystacked 0    3 353038.046  394480.494  367227.339  347314.062  269690.103  384968.659  
    Y2_pystacked 1    3 321312.360  520612.415  288723.882  273938.038  350669.699  215401.290  
    Y2_pystacked 0    4 345795.454  340163.825  333237.694  362400.057  322840.166  371024.065  
    Y2_pystacked 1    4 304419.854  288558.874  213486.112  247454.113  349505.266  400323.070  
    Y2_pystacked 0    5 340003.410  320712.353  379194.785  360504.448  287147.422  354614.719  
    Y2_pystacked 1    5 338144.945  346000.267  350599.426  304036.165  343506.245  345759.473  
    Y_bweight_ss 0    1  1.167e+07   1.161e+07   1.182e+07   1.159e+07   1.165e+07   1.169e+07  
    Y_bweight_ss 1    1  9.979e+06   1.009e+07   9.973e+06   1.008e+07   9.814e+06   9.915e+06  
    Y_bweight_ss 0    2  1.167e+07   1.166e+07   1.164e+07   1.175e+07   1.169e+07   1.161e+07  
    Y_bweight_ss 1    2  1.000e+07   1.009e+07   9.991e+06   1.011e+07   9.773e+06   1.002e+07  
    Y_bweight_ss 0    3  1.168e+07   1.164e+07   1.178e+07   1.160e+07   1.170e+07   1.167e+07  
    Y_bweight_ss 1    3  9.981e+06   9.824e+06   1.007e+07   9.697e+06   1.006e+07   1.024e+07  
    Y_bweight_ss 0    4  1.167e+07   1.169e+07   1.156e+07   1.167e+07   1.173e+07   1.169e+07  
    Y_bweight_ss 1    4  9.955e+06   9.958e+06   9.952e+06   9.863e+06   9.981e+06   1.001e+07  
    Y_bweight_ss 0    5  1.167e+07   1.169e+07   1.166e+07   1.158e+07   1.169e+07   1.175e+07  
    Y_bweight_ss 1    5  9.948e+06   9.824e+06   9.882e+06   1.016e+07   9.901e+06   9.974e+06  

MSEs for mbsmoke:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
        D1_logit   1      0.141       0.162       0.127       0.137       0.144       0.137  
        D1_logit   2      0.141       0.141       0.156       0.139       0.124       0.146  
        D1_logit   3      0.142       0.132       0.153       0.155       0.131       0.140  
        D1_logit   4      0.141       0.132       0.131       0.145       0.148       0.149  
        D1_logit   5      0.142       0.156       0.140       0.137       0.117       0.158  
    D2_pystacked   1      0.141       0.155       0.123       0.145       0.153       0.130  
    D2_pystacked   2      0.144       0.141       0.150       0.148       0.144       0.139  
    D2_pystacked   3      0.141       0.127       0.154       0.154       0.129       0.142  
    D2_pystacked   4      0.143       0.148       0.126       0.158       0.144       0.139  
    D2_pystacked   5      0.143       0.157       0.140       0.151       0.115       0.154  
   D3_svmachines   1      0.186       0.227       0.165       0.180       0.183       0.176  
   D3_svmachines   2      0.192       0.201       0.204       0.194       0.168       0.194  
   D3_svmachines   3      0.187       0.162       0.215       0.191       0.183       0.183  
   D3_svmachines   4      0.190       0.198       0.172       0.194       0.186       0.201  
   D3_svmachines   5      0.192       0.205       0.186       0.201       0.151       0.215  
    D_mbsmoke_ss   1      0.048       0.041       0.046       0.053       0.051       0.047  
    D_mbsmoke_ss   2      0.049       0.046       0.046       0.056       0.049       0.050  
    D_mbsmoke_ss   3      0.048       0.060       0.038       0.052       0.043       0.050  
    D_mbsmoke_ss   4      0.049       0.050       0.054       0.045       0.053       0.042  
    D_mbsmoke_ss   5      0.049       0.056       0.049       0.052       0.043       0.046  

. ddml extract, show(n)

Sample sizes for bweight:
                D=  rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
          Y1_reg 0    1       1135         215         231         231         230         228  
          Y1_reg 1    1        258          63          48          47          49          51  
          Y1_reg 0    2       1135         224         224         230         233         224  
          Y1_reg 1    2        258          54          55          48          46          55  
          Y1_reg 0    3       1135         236         221         223         227         228  
          Y1_reg 1    3        258          42          58          55          52          51  
          Y1_reg 0    4       1135         226         233         228         226         222  
          Y1_reg 1    4        258          52          46          50          53          57  
          Y1_reg 0    5       1135         221         229         227         238         220  
          Y1_reg 1    5        258          57          50          51          41          59  
    Y2_pystacked 0    1       1135         215         231         231         230         228  
    Y2_pystacked 1    1        258          63          48          47          49          51  
    Y2_pystacked 0    2       1135         224         224         230         233         224  
    Y2_pystacked 1    2        258          54          55          48          46          55  
    Y2_pystacked 0    3       1135         236         221         223         227         228  
    Y2_pystacked 1    3        258          42          58          55          52          51  
    Y2_pystacked 0    4       1135         226         233         228         226         222  
    Y2_pystacked 1    4        258          52          46          50          53          57  
    Y2_pystacked 0    5       1135         221         229         227         238         220  
    Y2_pystacked 1    5        258          57          50          51          41          59  
    Y_bweight_ss 0    1       1135           0           0           0           0           0  
    Y_bweight_ss 1    1        258           0           0           0           0           0  
    Y_bweight_ss 0    2       1135           0           0           0           0           0  
    Y_bweight_ss 1    2        258           0           0           0           0           0  
    Y_bweight_ss 0    3       1135           0           0           0           0           0  
    Y_bweight_ss 1    3        258           0           0           0           0           0  
    Y_bweight_ss 0    4       1135           0           0           0           0           0  
    Y_bweight_ss 1    4        258           0           0           0           0           0  
    Y_bweight_ss 0    5       1135           0           0           0           0           0  
    Y_bweight_ss 1    5        258           0           0           0           0           0  

Sample sizes for mbsmoke:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
        D1_logit   1       1393         278         279         278         279         279  
        D1_logit   2       1393         278         279         278         279         279  
        D1_logit   3       1393         278         279         278         279         279  
        D1_logit   4       1393         278         279         278         279         279  
        D1_logit   5       1393         278         279         278         279         279  
    D2_pystacked   1       1393         278         279         278         279         279  
    D2_pystacked   2       1393         278         279         278         279         279  
    D2_pystacked   3       1393         278         279         278         279         279  
    D2_pystacked   4       1393         278         279         278         279         279  
    D2_pystacked   5       1393         278         279         278         279         279  
   D3_svmachines   1       1393         278         279         278         279         279  
   D3_svmachines   2       1393         278         279         278         279         279  
   D3_svmachines   3       1393         278         279         278         279         279  
   D3_svmachines   4       1393         278         279         278         279         279  
   D3_svmachines   5       1393         278         279         278         279         279  
    D_mbsmoke_ss   1       1393         278         279         278         279         279  
    D_mbsmoke_ss   2       1393         278         279         278         279         279  
    D_mbsmoke_ss   3       1393         278         279         278         279         279  
    D_mbsmoke_ss   4       1393         278         279         278         279         279  
    D_mbsmoke_ss   5       1393         278         279         278         279         279  

. 
. ******************************************************************************** 
. **** Interactive IV model--LATE estimation.                                                             ****
. ******************************************************************************** 
. 
. 
. use http://fmwww.bc.edu/repec/bocode/j/jtpa.dta,clear

. keep in 1/1000
(10,204 observations deleted)

. global Y earnings

. global D training

. global Z assignmt

. global X sex age married black hispanic

. set seed 42

. 
. ddml init interactiveiv, kfolds(5) reps(2)
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. 
. ddml E[Y|X,Z]: reg $Y $X
Learner Y1_reg added successfully.

. ddml E[Y|X,Z]: pystacked $Y c.($X)# #c($X), type(reg) m(lassocv rf )
Learner Y2_pystacked added successfully.

. ddml E[D|X,Z]: logit $D $X
Learner D1_logit added successfully.

. ddml E[D|X,Z]: pystacked $D c.($X)# #c($X), type(class) m(lassocv rf)
Learner D2_pystacked added successfully.

. ddml E[Z|X]: logit $Z $X
Learner Z1_logit added successfully.

. ddml E[Z|X]: pystacked $Z c.($X)# #c($X), type(class) m(lassocv rf)
Learner Z2_pystacked added successfully.

. 
. ddml crossfit, shortstack
Cross-fitting E[y|X,Z] equation: earnings
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting E[D|X,Z] equation: training
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting E[Z|X]: assignmt
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting...completed short-stacking

. ddml estimate


Model:                  interactiveiv, crossfit folds k=5, resamples r=2
Mata global (mname):    m0
Dependent variable (Y): earnings
 earnings learners:     Y1_reg Y2_pystacked
D equations (1):        training
 training learners:     D1_logit D2_pystacked
Z equations (1):        assignmt
 assignmt learners:     Z1_logit Z2_pystacked

DDML estimation results (LATE):
spec  r  Y(0) learner  Y(1) learner  D(0) learner  D(1) learner         b        SE      Z learner
 mse  1        Y1_reg        Y1_reg  D2_pystacked  D2_pystacked  1485.567 (1811.562)      Z1_logit
  ss  1  [shortstack]          [ss]          [ss]          [ss]  3066.864 (2025.604)          [ss]
 mse  2  Y2_pystacked        Y1_reg  D2_pystacked      D1_logit  1181.885 (1807.462)  Z2_pystacked
  ss  2  [shortstack]          [ss]          [ss]          [ss]   361.795 (2075.749)          [ss]
mse = minimum MSE specification for that resample.

Mean/med Y(0) learner  Y(1) learner  D(0) learner  D(1) learner         b        SE      Z learner
 mse mn     [min-mse]     [min-mse]     [min-mse]     [min-mse]  1333.726 (1815.868)         [mse]
  ss mn  [shortstack]          [ss]          [ss]          [ss]  1714.330 (2456.318)          [ss]
 mse md     [min-mse]     [min-mse]     [min-mse]     [min-mse]  1333.726 (1815.873)         [mse]
  ss md  [shortstack]          [ss]          [ss]          [ss]  1714.330 (2456.675)          [ss]

Shortstack DDML model (median over 2 resamples) (LATE)
E[y|X,Z=0]   = Y_earnings_ss0                      Number of obs   =      1000
E[y|X,Z=1]   = Y_earnings_ss1
E[D|X,Z=0]   = D_training_ss0
E[D|X,Z=1]   = D_training_ss1
E[Z|X]       = Z_assignmt_ss
------------------------------------------------------------------------------
             |               Robust
    earnings |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    training |    1714.33   2456.675     0.70   0.485    -3100.665    6529.324
------------------------------------------------------------------------------
Stacking final estimator: nnls1

Summary over 2 resamples:
       D eqn      mean       min       p25       p50       p75       max
    training   1714.3296  361.7952  361.7952 1714.3296 3066.8640 3066.8640

. 
. ddml extract, show(ssweights)

short-stacked weights across resamples for assignmt
final stacking estimator: nnls1
                  learner  mean_weight        rep_1        rep_2
    Z1_logit            1     .5030659    .58274881    .42338298
Z2_pystacked            2     .4969341    .41725119    .57661702

short-stacked weights across resamples for earnings
final stacking estimator: nnls1
                  learner        Z=0/1  mean_weight        rep_1        rep_2
      Y1_reg            1            0    .38453545    .54467217    .22439873
Y2_pystacked            2            0    .61546455    .45532783    .77560127
      Y1_reg            1            1    .99965516            1    .99931031
Y2_pystacked            2            1    .00034484            0    .00068969

short-stacked weights across resamples for training
final stacking estimator: nnls1
                  learner        Z=0/1  mean_weight        rep_1        rep_2
    D1_logit            1            0     .6424374    .50969841    .77517639
D2_pystacked            2            0     .3575626    .49030159    .22482361
    D1_logit            1            1    .48821608    .30244817    .67398398
D2_pystacked            2            1    .51178392    .69755183    .32601602

. ddml extract, show(mse)

MSEs for assignmt:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
        Z1_logit   1      0.220       0.229       0.211       0.223       0.222       0.213  
        Z1_logit   2      0.219       0.214       0.218       0.223       0.215       0.226  
    Z2_pystacked   1      0.220       0.232       0.210       0.223       0.221       0.212  
    Z2_pystacked   2      0.219       0.210       0.218       0.226       0.218       0.223  
   Z_assignmt_ss   1      0.463       0.484       0.458       0.455       0.462       0.457  
   Z_assignmt_ss   2      0.465       0.462       0.449       0.476       0.463       0.471  

MSEs for earnings:
                Z=  rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
          Y1_reg 0    1  3.091e+08   2.677e+08   3.149e+08   2.573e+08   3.105e+08   4.065e+08  
          Y1_reg 1    1  3.044e+08   3.311e+08   2.112e+08   3.040e+08   3.233e+08   3.563e+08  
          Y1_reg 0    2  3.067e+08   3.020e+08   2.562e+08   3.645e+08   3.619e+08   2.476e+08  
          Y1_reg 1    2  3.054e+08   3.313e+08   3.342e+08   2.939e+08   2.970e+08   2.684e+08  
    Y2_pystacked 0    1  3.104e+08   2.471e+08   3.279e+08   2.407e+08   3.229e+08   4.289e+08  
    Y2_pystacked 1    1  3.121e+08   3.308e+08   2.279e+08   3.053e+08   3.442e+08   3.557e+08  
    Y2_pystacked 0    2  3.003e+08   3.019e+08   2.427e+08   3.628e+08   3.619e+08   2.316e+08  
    Y2_pystacked 1    2  3.091e+08   3.446e+08   3.322e+08   2.923e+08   3.038e+08   2.701e+08  
   Y_earnings_ss 0    1  2.702e+08   2.979e+08   2.360e+08   2.883e+08   2.848e+08   2.356e+08  
   Y_earnings_ss 1    1  2.978e+08   2.913e+08   3.199e+08   2.780e+08   2.924e+08   3.056e+08  
   Y_earnings_ss 0    2  2.713e+08   3.020e+08   2.756e+08   2.622e+08   2.832e+08   2.374e+08  
   Y_earnings_ss 1    2  2.962e+08   2.741e+08   2.989e+08   2.985e+08   3.034e+08   3.069e+08  

MSEs for training:
                Z=  rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
        D1_logit 0    1      0.019       0.000       0.071       0.000       0.030       0.023  
        D1_logit 1    1      0.222       0.237       0.229       0.207       0.228       0.210  
        D1_logit 0    2      0.023       0.028       0.000       0.024       0.029       0.044  
        D1_logit 1    2      0.221       0.223       0.209       0.220       0.223       0.227  
    D2_pystacked 0    1      0.016       0.000       0.049       0.000       0.016       0.018  
    D2_pystacked 1    1      0.219       0.240       0.225       0.204       0.226       0.203  
    D2_pystacked 0    2      0.017       0.019       0.000       0.016       0.017       0.031  
    D2_pystacked 1    2      0.223       0.227       0.209       0.220       0.226       0.231  
   D_training_ss 0    1      0.001       0.000       0.001       0.000       0.001       0.002  
   D_training_ss 1    1      0.456       0.479       0.459       0.429       0.460       0.452  
   D_training_ss 0    2      0.001       0.001       0.000       0.001       0.001       0.001  
   D_training_ss 1    2      0.451       0.455       0.438       0.437       0.473       0.452  

. ddml extract, show(n)

Sample sizes for assignmt:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
        Z1_logit   1       1000         200         200         200         200         200  
        Z1_logit   2       1000         200         200         200         200         200  
    Z2_pystacked   1       1000         200         200         200         200         200  
    Z2_pystacked   2       1000         200         200         200         200         200  
   Z_assignmt_ss   1       1000         200         200         200         200         200  
   Z_assignmt_ss   2       1000         200         200         200         200         200  

Sample sizes for earnings:
                Z=  rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
          Y1_reg 0    1        323          70          59          67          66          61  
          Y1_reg 1    1        677         130         141         133         134         139  
          Y1_reg 0    2        323          60          64          68          64          67  
          Y1_reg 1    2        677         140         136         132         136         133  
    Y2_pystacked 0    1        323          70          59          67          66          61  
    Y2_pystacked 1    1        677         130         141         133         134         139  
    Y2_pystacked 0    2        323          60          64          68          64          67  
    Y2_pystacked 1    2        677         140         136         132         136         133  
   Y_earnings_ss 0    1        323           0           0           0           0           0  
   Y_earnings_ss 1    1        677           0           0           0           0           0  
   Y_earnings_ss 0    2        323           0           0           0           0           0  
   Y_earnings_ss 1    2        677           0           0           0           0           0  

Sample sizes for training:
                Z=  rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
        D1_logit 0    1        254          70          41          67          34          42  
        D1_logit 1    1        677         130         141         133         134         139  
        D1_logit 0    2        221          37          64          41          35          44  
        D1_logit 1    2        677         140         136         132         136         133  
    D2_pystacked 0    1        323          70          59          67          66          61  
    D2_pystacked 1    1        677         130         141         133         134         139  
    D2_pystacked 0    2        323          60          64          68          64          67  
    D2_pystacked 1    2        677         140         136         132         136         133  
   D_training_ss 0    1        254           0           0           0           0           0  
   D_training_ss 1    1        677           0           0           0           0           0  
   D_training_ss 0    2        221           0           0           0           0           0  
   D_training_ss 1    2        677           0           0           0           0           0  

. 
. ******************************************************************************** 
. **** Flexible IV                                                                                                     
>            ****
. ******************************************************************************** 
. 
. use https://github.com/aahrens1/ddml/raw/master/data/BLP.dta, clear

. global Y share

. global D price

. global X hpwt air mpd space

. global Z sum*

. set seed 42

. 
. ddml init fiv
warning - model m0 already exists
all existing model results and variables will
be dropped and model m0 will be re-initialized

. 
. ddml E[Y|X]: reg $Y $X
Learner Y1_reg added successfully.

. ddml E[Y|X]: pystacked $Y $X, type(reg)
Learner Y2_pystacked added successfully.

. 
. ddml E[D|Z,X], learner(Dhat_reg): reg $D $X $Z
Learner Dhat_reg added successfully.

. ddml E[D|Z,X], learner(Dhat_pystacked): pystacked $D $X $Z, type(reg)
Learner Dhat_pystacked added successfully.

. 
. ddml E[D|X], learner(Dhat_reg) vname($D): reg {D} $X
Learner Dhat_reg_h added successfully.

. ddml E[D|X], learner(Dhat_pystacked) vname($D): pystacked {D} $X, type(reg)
Learner Dhat_pystacked_h added successfully.

.  
. ddml crossfit
Cross-fitting E[y|X,Z] equation: share
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting
Cross-fitting E[D|X,Z] and E[D|X] equation: price
Cross-fitting fold 1 2 3 4 5 ...completed cross-fitting

. ddml estimate


Model:                  fiv, crossfit folds k=5, resamples r=1
Mata global (mname):    m0
Dependent variable (Y): share
 share learners:        Y1_reg Y2_pystacked
D equations (1):        price
 price learners:        Dhat_reg Dhat_pystacked

DDML estimation results:
spec  r     Y learner     D learner         b        SE     DH learner
 mse  1  Y2_pystacked Dhat_pystac~d    -0.098    (0.008) Dhat_pystac~h
mse = minimum MSE specification for that resample.

Min MSE DDML model
y-E[y|X]  = y-Y2_pystacked_1                       Number of obs   =      2217
E[D|X,Z]  = D-Dhat_pystacked_1 
E[D^|X]   = Dhat_pystacked_h_1
Orthogonalized D = D - E[D^|X]; optimal IV = E[D|X,Z] - E[D^|X].
------------------------------------------------------------------------------
       share |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
       price |  -.0978842   .0079847   -12.26   0.000     -.113534   -.0822344
       _cons |   .0032566   .0215635     0.15   0.880    -.0390072    .0455204
------------------------------------------------------------------------------


. local a1 = _b[price]

. 
. ddml extract, show(mse)

MSEs for price:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
  Dhat_pystacked   1     10.799       9.015      11.548      12.415      11.323       9.695  
Dhat_pystacked_h   1     18.043      15.932      19.879      17.245      20.135      17.028  
        Dhat_reg   1     28.140      24.216      28.043      27.213      31.266      29.959  
      Dhat_reg_h   1     32.835      29.017      32.258      32.653      37.099      33.149  

MSEs for share:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
          Y1_reg   1      1.432       1.522       1.379       1.515       1.447       1.296  
    Y2_pystacked   1      1.167       1.277       1.132       1.206       1.210       1.009  

. ddml extract, show(n)

Sample sizes for price:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
  Dhat_pystacked   1       2217         443         443         444         443         444  
Dhat_pystacked_h   1       2217         443         443         444         443         444  
        Dhat_reg   1       2217         443         443         444         443         444  
      Dhat_reg_h   1       2217         443         443         444         443         444  

Sample sizes for share:
                 rep   full smp      fold 1      fold 2      fold 3      fold 4      fold 5 
          Y1_reg   1       2217         443         443         444         443         444  
    Y2_pystacked   1       2217         443         443         444         443         444  

. 
. cap drop Ytilde

. cap drop Dtilde

. cap drop Zopt

. gen Ytilde = $Y - Y2_pystacked_1

. gen Dtilde = $D - Dhat_pystacked_h_1

. gen Zopt = Dhat_pystacked_1 - Dhat_pystacked_h_1

.  
. ivreg Ytilde (Dtilde=Zopt) 

Instrumental variables (2SLS) regression

      Source |       SS           df       MS      Number of obs   =     2,217
-------------+----------------------------------   F(1, 2215)      =    150.28
       Model |  303.966601         1  303.966601   Prob > F        =    0.0000
    Residual |  2282.97989     2,215   1.0306907   R-squared       =    0.1175
-------------+----------------------------------   Adj R-squared   =    0.1171
       Total |  2586.94649     2,216  1.16739463   Root MSE        =    1.0152

------------------------------------------------------------------------------
      Ytilde |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      Dtilde |  -.0978842   .0079847   -12.26   0.000    -.1135426   -.0822258
       _cons |   .0032566   .0215635     0.15   0.880    -.0390303    .0455435
------------------------------------------------------------------------------
Instrumented:  Dtilde
Instruments:   Zopt
------------------------------------------------------------------------------

. local b1 = _b[Dtil]

. assert reldif(`a1',`b1')<$tol

. 
. log close
      name:  <unnamed>
       log:  C:\LocalStore\ecomes\Documents\GitHub\ddml\cert\ddml_cert.log
  log type:  text
 closed on:  28 Jul 2023, 13:37:23
-----------------------------------------------------------------------------------------------------------------------
